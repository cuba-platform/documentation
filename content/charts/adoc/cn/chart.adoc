[[chart]]
== Displaying Charts

CUBA platform charts display subsystem supports various chart types: pie charts, line plots, bubble charts, radar charts, funnel charts, stock charts and more. It is also possible to export charts. Most chart types support zoom and scrolling. The charts are supported in web client only.

AmCharts library which is the basis of the chart display subsystem is distributed under a license, which allows its free use if you keep the link to the library website. Alternatively, you can http://www.amcharts.com/online-store[purchase^] an AmCharts license for your project and remove the link.

[[chart_dependency]]
=== Add Charts Dependency
To use charts in your project, activate the *charts* item in the *App components* list on the *Project properties* page of CUBA Studio.

[[chart_configuration]]
=== Configuring Charts

Charts are displayed using the `Chart` component acting as a universal canvas. Chart type is defined by the <<chart_types,subtype interface>> that inherits the `Chart` interface.

Charts can be described both in a screen XML-descriptor or in a screen controller. To do this, you should connect the corresponding `namespace` to the descriptor:

[source, xml]
----
<window xmlns="http://schemas.haulmont.com/cuba/window.xsd"
        xmlns:chart="http://schemas.haulmont.com/charts/charts.xsd"
        ...>
----

XML elements corresponding to different chart types:

* `chart:xyChart` - <<xy_chart,XYChart>>
* `chart:serialChart` - <<serial_chart,SerialChart>>
* `chart:pieChart` - <<pie_chart,PieChart>>
* `chart:funnelChart` - <<funnel_chart,FunnelChart>>
* `chart:gaugeChart` - <<gauge_chart,AngularGaugeChart>>
* `chart:radarChart` - <<radar_chart,RadarChart>>
* `chart:ganttChart` - <<gantt_chart,GanttChart>>
* `chart:stockChart` - <<stock_chart,StockChart>>

Each chart type has its own set of attributes and methods, which replicate the functionality of the corresponding charts from AmCharts library. Documentation on the properties and methods of the charts is available at http://docs.amcharts.com/3/javascriptcharts[docs.amcharts.com/3/javascriptcharts^].

The following elements can be used for declarative configuration of all types of charts:

[[chart_allLabels]]
* `chart:allLabels` - contains the `label` elements with label text and its properties. Labels can be placed on a certain position on the chart, for example:
+
--

image::chart/charts_allLabels.png[align="center"]

[source, xml]
----
include::{sourcesdir}/chart/chart_allLabels.xml[]
----
--

[[chart_balloon]]
* `chart:balloon` - sets the configurations of balloons (tooltips) of the chart that follow the mouse cursor when you roll-over the data items. For example:
+
--
image::chart/charts_balloon.png[align="center"]

[source, xml]
----
include::{sourcesdir}/chart/chart_balloon.xml[]
----

The balloon text is defined by the `balloonText` attribute of each chart graph.

[[chart_additionalFields]]
** `additionalFields` attribute
+
Interpolation of chart data is available for all fields used in the chart, such as `titleField`, `valueField`, `category`, `value`, `description`, `percents`, `open` etc, as well as HTML tags.
+
You can also fetch more entity attributes from the data provider using the `additionalFields` attribute. This attribute allows you to add the passed entity attributes to the chart query and send the extracted data to the UI, so that you can use the entity attribute names directly in the chart configuration.
+
In the example below `title` is the graph title, `category` is the value on the category axis, `value` is the value on the value axis, and `optional` is the `IncomeExpenses` entity attribute fetched to be interpolated in the `balloonText`:
+
[source, xml]
----
include::{sourcesdir}/chart/chart_additionalFields.xml[]
----
+
image::chart/charts_balloon_additiional.png[align="center"]
+
The list of fields can be added declaratively as a comma-separated string:
+
[source, xml]
----
additionalFields="income,expense,vat"
----
+
or programmatically in the screen controller:
+
[source, java]
----
include::{sourcesdir}/chart/chart_additionalFields.java[]
----
--

[[chart_chartScrollbar]]
* `chart:chartScrollbar` (for <<serial_chart>> and <<xy_chart>>) - the chart's scrollbar.
+
--
* You can set the concrete graph to zoom by the scrollbar, for example:
+
image::chart/charts_zoom.png[align="center"]
+
[source, xml]
----
include::{sourcesdir}/chart/chart_chartScrollbar.xml[]
----

* The `chart:chartScrollbarSettings` element enables you to customize the scrollbar's properties.
+
[source, xml]
----
include::{sourcesdir}/chart/chart_chartScrollbar2.xml[]
----

* In addition, the <<gantt_chart>> may have a `chart:valueScrollbar` element for scrolling the value axis, while `chart:chartScrollbar` will be used for zooming the category axis.
+
image::chart/charts_valueScrollBar.png[align="center"]
+
[source, xml]
----
include::{sourcesdir}/chart/charts_valueScrollBar.xml[]
----
--

[[chart_cursor]]
* `chart:cursor` - an optional element adding a cursor to the chart; the cursor follows the mouse pointer and shows a tooltip with the value of the corresponding point on a chart.
+
--
image::chart/charts_cursor.png[align="center"]

[source, xml]
----
include::{sourcesdir}/chart/chart_cursor.xml[]
----
--

* `chart:data` - an optional element for <<chart_data,data binding>> used mostly for prototyping.

* `chart:export` - an optional element that enables chart <<chart_export,export>>. The default export implementation adds a floating *download* button on the chart:
+
image::chart/charts_export.png[align="center"]

[[chart_guides]]
* `chart:guides` - horizontal/vertical guidelines.
+
--
image::chart/charts_guides.png[align="center"]

[source, xml]
----
include::{sourcesdir}/chart/chart_guides.xml[]
----
--

[[chart_legend]]
* `chart:legend` - an element that defines the chart legend, for example:
+
--
image::chart/charts_legend.png[align="center"]

[source, xml]
----
include::{sourcesdir}/chart/chart_legend.xml[]
----
--

* `chart:nativeJson` - <<custom_json,JSON configuration>> of the chart.

[[chart_titles]]
* `chart:titles` - axis titles, for example:
+
--
image::chart/charts_titles.png[align="center"]
[source, xml]
----
include::{sourcesdir}/chart/chart_titles.xml[]
----
--

[[chart_responsive]]
* `chart:responsive` - the chart plugin that makes the chart responsive.
+
--
It enables scaling-down and -up chart visual features automatically in order to adjust the chart to the screen resolution changes. You can find more information on the `responsive` plugin on the https://www.amcharts.com/kbase/making-charts-responsive/[AmCharts website].

The `responsive` element should contain the enclosed `rules` element where the rules of accommodation are defined. You can make the chart hide or show the legend, axis titles, guides, chart titles, zoom controls, move labels inside plot area and so on:

[source,xml]
----
include::{sourcesdir}/chart/responsive.xml[]
----
--

Any configuration attribute can be set to `null`; in this case the system will use the default value (except the cases specified in the AmCharts documentation).

Configuring charts in a screen controller is performed following the same logic. You can configure a simple property, as well as a composite object set:

[source,java]
----
include::{sourcesdir}/chart/chart_configure.java[]
----

[[chart_export]]
=== Charts Export

All charts can be exported from the running application as a picture or a source data. The `chart:export` element is used to create default export menu that enables the following options:

* *Download as...* with available formats: PNG, JPG, SVG, PDF
* *Save as...* with available formats: CSV, XLSX, JSON
* *Annotate...* which is used to add personal notes and vector shapes to the chart. You can find information on the annotation plugin https://www.amcharts.com/export-now-supports-annotating-charts-with-text-icons-arrows/[here].
* *Print* that opens the standard print settings window.

image::chart/charts_export_menu_1.png[align="center"]

The export menu can be customized to limit user access to the chart data, for example:

[source,xml]
----
include::{sourcesdir}/chart/chart_export_menu.xml[]
----

In this case only direct download buttons for chosen formats will be available:

image::chart/charts_export_menu_2.png[align="center"]

You can define the following export settings:

* `backgroundColor` - code of the color for the background of the exported image. Default value is `#FFFFFF`.
* `dataDateFormat` - the format to convert date strings to date objects in data export only.
* `dateFormat` - formats the category field in the given date format (data export only).
* `enabled` - enables or disables the export functionality.
* `exportSelection` - exports the current data selection only. Default value is `false`.
* `exportTitles` - exchanges the data field names with its dedicated title. Default value is `false`.
* `fileListener` - if `true`, it observes the drag and drop feature and loads the dropped image file into the annotation. Default value is `false`.
* `fileName` - a file name to use for generated export files (an extension will be appended to it based on the export format).
* `keyListener` - if `true`, observes the pressed keys to undo/redo the annotations.
* `position` - position of export icon. Possible values: `TOP_LEFT`, `TOP_RIGHT` (DEFAULT), `BOTTOM_LEFT`, `BOTTOM_RIGHT`.
* `removeImages` - if `true`, export checks for and removes unnecessary images that area loaded from different domains.

The following properties enable you to customize each export option:

JPG::
+
* `quality` - quality of the resulting image. Possible values `0` - `1`. Default value is `1`.

PNG, JPG, SVG, PDF::
+
* `multiplier` - scale factor for the generated image.

CSV::
+
--
* `quotes` - sets whether to enclose strings in double quotes. Default value is `true`.
* `delimiter` - a string to use as a column delimiter. Default value is "," (comma).
* `escape` - defines whether to escape strings. Default value is true.
* `withHeader` - adds header row with column names. Default value is `true`.
--

XLSX::
+
--
* `dateFormat` - the XLSX date format mask. Do not forget to set `parseDates` to `true` in CategoryAxis.
* `stringify` - converts all cell content to strings. Default value is `false`.
* `withHeader` - adds header row with column names. Default value is `true`.
--

PDF::
+
--
* `pageOrientation` - the page orientation. Default value is `PORTRAIT`.
* `pageOrigin` - shows / hides the origin of the generated PDF. Default value is `true`.
* `pageSize` - the format of PDF list. Default value is `A4`.

Additionally, you can override the string for `label.saved.from` message in the main message pack.
--

PRINT::
* `delay` - delay before triggering print in seconds.
* `lossless` - enables or disables image optimization when printing. Default value is `false`.

[[chart_data_binding]]
=== Connecting Data

There are three ways how you can pass data to a chart: through the `DataProvider` interface, using the datasource mechanism, or the <<chart_data_simplified,simplified data binding API>>, which allows adding the data directly using the `addData()` method and convenient `MapDataItem` constructors for those charts that are not bound to a datasource.

[[chart_data_provider]]
DataProvider: ::
+
--
The `DataProvider` interface has a standard implementation: `ListDataProvider` class. It contains a list of `DataItem` instances from which the data for the chart will be taken. There are several standard implementations of `DataItem` interface:

* `EntityDataItem` takes an instance of any entity.
* `MapDataItem` is a set of key-value pairs.
* `SimpleDataItem` takes an instance of any `public` class.

An instance of `DataProvider` is passed to the `setDataProvider()` method of chart configuration. This approach to providing chart data is the most universal, but it requires creating instances of `DataProvider` and `DataItem` in a screen controller.
--

[[chart_datasource]]
Datasource: ::
+
--
A `CollectionDatasource` type datasource can be assigned to a `Chart` component by invoking the `setDatasource()` method. This approach requires an entity that will represent chart data. It may be convenient when such entity already exists in the application data model and also when chart data should be displayed as a table.

<<chart_example>> illustrates all three approaches to providing chart data.

Entity properties or the values contained in an instance of `DataProvider` which are used for display purposes are defined in the chart attributes. The set of chart attributes may differ for different chart types. For example, for the `chart:pieChart` component, you should define the `valueField` and `titleField` attributes. The following types are allowed for attribute values: `Integer`, `Long`, `Double`, `String`, `Boolean`, `Date`.

Dynamic addition of data to an existing chart is supported for both the datasource and the data provider mechanisms.
--

[[chart_data]]
chart:data element: ::
+
--
This option is useful for quick prototyping of charts. The `chart:data` element and its nested `item` elements enable you to set key-value pairs of data directly in the XML descriptor of the chart, for example:

[source, xml]
----
include::{sourcesdir}/chart/chart_data.xml[]
----
--

[[chart_listeners]]
=== Events

It is possible to configure handling of different event types for each chart type. The following listener types are available for all chart subtypes:

* `LegendItemHideListener` - hiding a legend item.
* `LegendItemShowListener` - showing a legend item.
* `LegendLabelClickListener` - click on a legend label.
* `LegendMarkerClickListener` - click on a legend marker.

More event listeners for the exact chart subtype instance you can find in the corresponding <<chart_types,sections>> of the manual.

Event handling examples are available in <<section_use_of_events>>.

In order to migrate the old code that uses event listeners, the `Chart` component should be cast to a concrete chart subtype or re-injected with a concrete subtype:

[source,java]
----
include::{sourcesdir}/chart/injectChart.java[]
----

[source,java]
----
((PieChart)pieChart).addSliceClickListener(event -> {});
----

Above the listeners, `SeriesBasedChart` interface contains `zoomOut`, `zoomToIndexes`, and `zoomToDates` methods for manipulating the chart axis.

The `CoordinateChart` interface similarly provides the following methods for the value axis:  `zoomOutValueAxes`, `zoomOutValueAxis`, `zoomOutValueAxis`, `zoomValueAxisToValues`, and `zoomValueAxisToValues`.

[[chart_types]]
=== Chart Types
There are several chart types supported by CUBA platform.

.Chart Types Hierarchy
image::chart/charts_hierarchy_diagram.png[align="center"]

The chart interfaces are implemented in the following Chart components:

* <<gauge_chart,AngularGaugeChart>>,
* <<funnel_chart,FunnelChart>>,
* <<gantt_chart,GanttChart>>,
* <<pie_chart,PieChart>>,
* <<radar_chart,RadarChart>>,
* <<serial_chart,SerialChart>>,
* <<xy_chart,XYChart>>.

All these components have `NAME` constant, so they can be created using `ComponentsFactory`.

[[gauge_chart]]
==== AngularGaugeChart

The `AngularGaugeChart` component allows you to create gauge charts.

++++
<div class="manual-live-demo-container">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=gauge-chart" class="live-demo-btn" target="_blank">LIVE DEMO</a>
</div>
++++

.GaugeChart
image::chart/gauge-chart.svg[align="center", width="800"]

XML name of the component: `chart:gaugeChart`.

Elements of `chart:gaugeChart`::
+
--
* `arrows` - includes the nested `arrow` elements for the chart arrow axes.
+
[source, xml]
----
<chart:arrows>
    <chart:arrow value="60"/>
</chart:arrows>
----

* `axes` - includes the nested `axis` elements for the chart axes.
+
[source, xml]
----
include::{sourcesdir}/chart/chart_axes.xml[]
----
+
The `band` element enables you to split an axis into several bands, as on the picture above:
+
[source, xml]
----
include::{sourcesdir}/chart/chart_axes_band.xml[]
----
+
The `endValue` and `startValue` attributes are used to set the range of values on the chart, the `valueInterval` attribute defines the gauge scale marks.
--

`AngularGaugeChart` event listeners: ::
+
--
* `ChartClickListener` - click on the canvas.
* `ChartRightClickListener` - right click on the canvas.
--

For more details, see http://docs.amcharts.com/3/javascriptcharts/AmAngularGauge[AmCharts documentation].

[[funnel_chart]]
==== FunnelChart

The `FunnelChart` component allows you to create funnel/pyramid charts.

++++
<div class="manual-live-demo-container">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=funnel3d-chart" class="live-demo-btn" target="_blank">LIVE DEMO</a>
</div>
++++

.FunnelChart
image::chart/funnel-chart.svg[align="center", width="800"]

XML name of the component: `chart:funnelChart`.

Data binding: ::
+
--
. You can assign a datasource of a `CollectionDatasource` type to the chart and then define the `titleField` and `valueField` attributes for the `funnelChart` element:
+
[source, xml]
----
include::{sourcesdir}/chart/funnelChart.xml[]
----

. Using the <<chart_data,chart:data>> element.
+
[source, xml]
----
include::{sourcesdir}/chart/funnel_chart.xml[]
----
--

`FunnelChart` event listeners: ::
+
--
* `SliceClickListener` - click on a slice in a pie chart.
* `SlicePullInListener` - shift of a slice of a pie chart into the chart.
* `SlicePullOutListener` - shift of a slice of a pie chart out of the chart.
* `SliceRightClickListener` - right-click on a slice in a pie chart.
--

For more details, see http://docs.amcharts.com/3/javascriptcharts/AmFunnelChart[AmCharts documentation].

[[gantt_chart]]
==== GanttChart

The `GanttChart` component allows you to create Gantt charts.

++++
<div class="manual-live-demo-container">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=gantt-chart" class="live-demo-btn" target="_blank">LIVE DEMO</a>
</div>
++++

.GanttChart
image::chart/gantt-chart.png[align="center", width="800"]

XML name of the component: `chart:ganttChart`.

Elements of `chart:ganttChart`: ::
+
--
* `categoryAxis` - an element that describes the category axis.

* `graph` - an element that contains the collection of `chart:graph` elements; the graph is described by the `chart:graph` element.
+
** the `type` attribute defines the type of the graph and can be: line, column, step line, smoothed line, OHLC and candlestick.
+
** the `valueField` attribute defines a key from the list of key-value pairs of the datasource or a data provider.

* `valueAxis` - value axis of the chart. If the chart data is date- or time-based, you can set the value axis type to `date`.
--

Attributes of `chart:ganttChart`: ::
+
--
* `segmentsField` - segments field of the chart.

* `additionalSegmentFields` - the list of additional segment fields that correspond to the entity attributes to be fetched from the data provider, similarly to the <<chart_additionalFields,additionalFields>> attribute.

* `endField`/`endDateField` - the end value or the end date of the chart.

* `startField`/`startDateField` - the start value or the start date of the chart.

* `startDate` - the chart start date, if the value axis type is `date`.

* `categoryField` - the category field of the chart.
--

Data binding::
+
--
You can assign a datasource of a `CollectionDatasource` type to the chart. In the example below the `start` and `end` attributes of an entity are set for the attributes `startDateField` and `endDateField`.

[source, xml]
----
include::{sourcesdir}/chart/gantt_chart.xml[]
----
--

`GanttChart` event listeners: ::
+
--
* `AxisZoomListener` - chart axis scaling.
* `CategoryItemClickListener` - click on a category in the category axis.
* `ChartClickListener` - click on the canvas.
* `ChartRightClickListener` - right click on the canvas.
* `CursorPeriodSelectListener` - selection of the display period with a cursor.
* `CursorZoomListener` - scaling of the chart area with a cursor.
* `GraphClickListener` - click on a graph.
* `GraphItemClickListener` - click on a graph item.
* `GraphItemRightClickListener` - right click on a graph item.
* `ZoomListener` - scaling of the canvas.
--

For more details, see http://docs.amcharts.com/3/javascriptcharts/AmGanttChart[AmCharts documentation].

[[pie_chart]]
==== PieChart

The `PieChart` component allows you to create pie/donut charts.

++++
<div class="manual-live-demo-container">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=pie3d-chart" class="live-demo-btn" target="_blank">LIVE DEMO</a>
</div>
++++

.PieChart
image::chart/pie-chart.svg[align="center", width="800"]

XML name of the component: `chart:pieChart`.

Data binding: ::
+
--
. Using a datasource.
+
You can assign a datasource of a `CollectionDatasource` type to the chart and then define the `titleField` and `valueField` attributes for the `pieChart` element:
+
[source, xml]
----
include::{sourcesdir}/chart/pie_chart.xml[]
----

. Using the <<chart_data,chart:data>> element.
--

`PieChart` event listeners: ::
+
--
* `ChartClickListener` - click on the canvas.
* `ChartRightClickListener` - right click on the canvas.
* `SliceClickListener` - click on a slice in a pie chart.
* `SlicePullInListener` - shift of a slice of a pie chart into the chart.
* `SlicePullOutListener` - shift of a slice of a pie chart out of the chart.
* `SliceRightClickListener` - right-click on a slice in a pie chart.
--

For more details, see http://docs.amcharts.com/3/javascriptcharts/AmPieChart[AmCharts documentation].

[[radar_chart]]
==== RadarChart

The `RadarChart` component allows you to create radar/polar charts.

++++
<div class="manual-live-demo-container">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=polar-chart" class="live-demo-btn" target="_blank">LIVE DEMO</a>
</div>
++++

.RadarChart
image::chart/radar-chart.svg[align="center", width="800"]

XML name of the component: `chart:radarChart`.

Data binding: ::
+
--
You can assign a datasource of a `CollectionDatasource` type to the chart and then define the `categoryField` attribute for the `radarChart` element and `valueField` attribute for the nested `graph` element:

[source, xml]
----
include::{sourcesdir}/chart/radar_chart.xml[]
----
--

`RadarChart` event listeners::
+
--
* `AxisZoomListener` - chart axis scaling.
* `ChartClickListener` - click on the canvas.
* `ChartRightClickListener` - right click on the canvas.
* `GraphClickListener` - click on a graph.
* `GraphItemClickListener` - click on a graph item.
* `GraphItemRightClickListener` - right click on a graph item.
--

For more details, see http://docs.amcharts.com/3/javascriptcharts/AmRadarChart[AmCharts documentation].

[[serial_chart]]
==== SerialChart

The `SerialChart` component allows you to create line, area, column, bar, step line, smoothed line, candlestick and OHLC charts. The charts support multiple axes with simple or logarithmic scales, the data points can be displayed at equal/irregular intervals or on timeline basis.

++++
<div class="manual-live-demo-container">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=line-chart" class="live-demo-btn" target="_blank">LIVE DEMO</a>
</div>
++++

.SerialChart as Line Chart
image::chart/line-chart.png[align="center", width="800"]

++++
<div class="manual-live-demo-container">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=columnline-chart" class="live-demo-btn" target="_blank">LIVE DEMO</a>
</div>
++++

.SerialChart as Column Chart
image::chart/column-chart.svg[align="center", width="800"]

XML name of the component: `chart:serialChart`.

Data binding: ::
+
--
You can assign a datasource of a `CollectionDatasource` type to the chart and then define the `categoryField` attribute for the `serialChart` element and `valueField` attribute for the nested `graph` element:

[source, xml]
----
include::{sourcesdir}/chart/serial_chart.xml[]
----
--

`SerialChart` event listeners::
+
--
* `AxisZoomListener` - chart axis scaling.
* `CategoryItemClickListener` - click on a category in the category axis.
* `ChartClickListener` - click on the canvas.
* `ChartRightClickListener` - right click on the canvas.
* `CursorPeriodSelectListener` - selection of the display period with a cursor.
* `CursorZoomListener` - scaling of the chart area with a cursor.
* `GraphClickListener` - click on a graph.
* `GraphItemClickListener` - click on a graph item.
* `GraphItemRightClickListener` - right click on a graph item.
* `ZoomListener` - scaling of the canvas.
--

For more details, see http://docs.amcharts.com/3/javascriptcharts/AmSerialChart[AmCharts documentation].

[[stock_chart]]
==== StockChartGroup

The `StockChartGroup` component allows you to create stock charts.

Stock chart supports multiple data sets and has a ready to use data set selector. Data sets might be compared one to another.

++++
<div class="manual-live-demo-container">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=stockchart-multiple-datasets" class="live-demo-btn" target="_blank">LIVE DEMO</a>
</div>
++++

.StockChart with multiple data sets
image::chart/stock-chart-with-datasets.svg[align="center", width="800"]

Stock chart can display a different kind of annotations on the graph or on the axis. These annotations are called stock events.

++++
<div class="manual-live-demo-container">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=stockchart-stock-events" class="live-demo-btn" target="_blank">LIVE DEMO</a>
</div>
++++

.StockChart with StockEvents
image::chart/stock-chart-with-stockevents.png[align="center", width="800"]

Stock chart can support any number of stock panels. Each Stock Panel can have any number of graphs. Each Stock Panel is
a separate serial chart and is based on SerialChart and so it can do anything this chart can.

++++
<div class="manual-live-demo-container">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=stockchart-multiple-panels" class="live-demo-btn" target="_blank">LIVE DEMO</a>
</div>
++++

.StockChart with multiple StockPanels
image::chart/stock-chart-with-panels.png[align="center", width="800"]

`StockChartGroup` event listeners::
+
--
* `DataSetSelectorCompareListener` - listener to dataset selector compare events.
* `DataSetSelectorSelectListener` - selection of the dataset selector.
* `DataSetSelectorUnCompareListener` - listener to the dataset selector uncompare events.
* `PeriodSelectorChangeListener` - selection of the display period with a selector.
* `StockChartClickListener` - click on the stock chart area.
* `StockChartRightClickListener` - right click on the stock chart area.
* `StockEventClickListener` - click on the stock event.
* `StockEventRollOutListener` - stock event roll-out.
* `StockEventRollOverListener` - stock event roll-over.
* `StockGraphClickListener` - click on the stock graph.
* `StockGraphItemClickListener` - click on the stock graph item.
* `StockGraphItemRightClickListener` - right click on the stock graph item.
* `StockGraphItemRollOutListener` - stock graph item roll-out events.
* `StockGraphItemRollOverListener` - stock graph item roll-over events.
* `StockGraphRollOutListener` - stock graph roll-out events.
* `StockGraphRollOverListener` - stock graph roll-over events.
* `ZoomListener` - scaling of the canvas.
* `ZoomListener` - scaling of the canvas.
--

[[xy_chart]]
==== XYChart

The `XYChart` component allows you to create XY/bubble/scatter charts. The charts support multiple axes with simple or logarithmic scales.

++++
<div class="manual-live-demo-container">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=xy-chart" class="live-demo-btn" target="_blank">LIVE DEMO</a>
</div>
++++

.XYChart
image::chart/xy-chart.png[align="center", width="800"]

XML name of the component: `chart:xyChart`.

Data binding: ::
+
--
You can assign a datasource of a `CollectionDatasource` type to the chart and then define the `xField` and `yFields` attributes for the nested `graph` elements:

[source, xml]
----
include::{sourcesdir}/chart/xy_chart.xml[]
----
--

`XYChart` event listeners::
+
--
* `AxisZoomListener` - chart axis scaling.
* `ChartClickListener` - click on the canvas.
* `CursorPeriodSelectListener` - selection of the display period with a cursor.
* `CursorZoomListener` - scaling of the chart area with a cursor.
* `GraphClickListener` - click on a graph.
* `GraphItemClickListener` - click on a graph item.
* `GraphItemRightClickListener` - right click on a graph item.
--

For more details, see http://docs.amcharts.com/3/javascriptcharts/AmXYChart[AmCharts documentation].

[[chart_example]]
=== Example of Working with Charts

This chapter shows how you can use the chart display subsystem.

[[chart_project_setup]]
==== Setting up the Application Project

. Run *CUBA Studio*, create new project and name it `sampler`.

. Open *Project properties* -> *Edit* and select the *charts* component in the list of *App components*; save changes.
Confirm when Studio will suggest recreating Gradle scripts.

. Select *Run* -> *Deploy*. At this point, the application will be assembled and deployed to the Tomcat application
server located at `build/tomcat`.

. Select *Build* -> *Create or update IDEA project files* to create project files for *IntelliJ IDEA*.

Once the steps above are complete, the chart display functionality will be connected to the application and ready to be used.

[[chart_data_simplified]]
==== Creating Chart with Simplified Data Binding

For the first example we will create the most simple chart using the simplified data binding API.

Add the chart component to the screen and use the `addData()` method to fill it with data, passing the `MapDataItem` instance with a set of key-value pairs as a parameter:

[source,xml]
----
include::{sourcesdir}/chart/chart_data_simplified.xml[]
----

[source,java]
----
include::{sourcesdir}/chart/chart_data_simplified.java[]
----

image::chart/chart_simple.png[align="center"]

[[chart_data_from_entity]]
==== Creating Chart with Data from an Entity

In this chapter we will create the chart similar to https://www.amcharts.com/demos/3d-stacked-column-chart/[3D Stacked Column Chart^] from AmCharts demos. This chart will retrieve data from a database, so the `datasource` attribute has to be defined. The `JavaScript` source code which amCharts use to define such chart is as follows:

[source,javascript]
----
include::{sourcesdir}/chart/column3d-chart.js[]
----

[[cdb_create_model]]
===== Creating an Entity

. Open the *DATA MODEL* tab in CUBA Studio and click *New -> Entity* button.

. In the *New entity* dialog type `CountryGrowth` in the *Class name* field, choose `Not persistent` for *Entity type* and click *OK* button.

. Using *Entity Designer* add attributes:
* `country` of the type `String`
* `year2014` of the type `Double`
* `year2015` of the type `Double`

. Open the *Source* tab to see generated source code:
+
[source,java]
----
include::{sourcesdir}/chart/CountryGrowth.java[]
----
+
This class describes non-persistent entity. An instance of this class contains the number of the country GDP growth rate for 2014 and 2015 years.

. Click *OK* button to save the entity and close the designer screen.

[[cdb_creating_chart]]
===== Creating Chart

[[cdb_xml_descriptor]]
====== Screen XML Descriptor

Open the *GENERIC UI* tab in CUBA Studio and create a screen in the *web* module. Enter the value `column3d-chart` in the *Descriptor* field. The fields - *Id*, *Controller Name* and *Messages Pack* will be filled in with appropriate values. Save changes. Open the *XML* tab and replace its content with the following code:

[source, xml]
----
include::{sourcesdir}/chart/column3d-chart.xml[]
----

The root element of the screen descriptor contains a new `xmlns:chart` attribute:

[source, xml]
----
<window xmlns:chart="http://schemas.haulmont.com/charts/charts.xsd"
    ...
>
----

The chart retrieves data from the `countryGrowthDs` datasource defined in the `datasource` attribute. Names and values are displayed using the `country`, `year2014` and `year2015` attributes of the `CountryGrowth` entity; the list of instances for this entity is stored in the datasource.

The `chart:serialChart` component contains the following attributes:

* `angle` - defines the chart angle. May have a value from `0` to `90`.

* `balloonText` - defines text for the tooltip that appears when hovering over a column. You can use the following tags: `\[[value]]`, `\[[title]]`, `\[[persents]]`, `\[[description]]`, as well as keys from the `DataItem` listed in a `DataProvider` instance, or names of the entity attributes from the datasource. To use `html` tags you must escape them.

* `depth3D` - chart thickness. When used in combination with the `angle` attribute, helps to create a 3D effect.

* `plotAreaFillAlphas` - opacity of the plot area.

* `startDuration` - duration of the animation, in seconds.

* `categoryField` - a key from the set of pairs contained in the `DataItem` objects listed in a `DataProvider` instance; this key is used to determine the labels for the category axis.

The `chart:serialChart` component contains the following elements:

* `chart:categoryAxis` - an element that describes the category axis.
** The `gridPosition` attribute specifies if a grid line is placed on the center of a cell or on the beginning of a cell.

* `chart:valueAxes` - an element that defines vertical value axes. In our case, only one vertical axis is used; the axis is described by the `chart:axis` element.
** The `position` attribute defines position of the value axis relative to the chart.
** Setting `stackType` to `BOX_3D` makes the chart display columns one behind the other.

* `chart:graphs` - an element that contains the collection of `chart:graph` elements; the graph is described by the `chart:graph` element.
** The `type` attribute defines the type of the graph and can be: line, column, step line, smoothed line, ohlc and candlestick.
** The `valueField` attribute defines a key from the list of pairs contained in the `DataItem` objects listed in a `DataProvider` instance; this key is used to determine the value.
** The `fillAlphas` attribute defines opacity of fill.
** The `lineAlpha` attribute defines opacity of the line (or column border). Value range is 0 - 1.

* `chart:export` – an optional element that enables chart export.

[[cdb_screen_controller]]
====== Screen Controller

Open the *Controller* tab and replace its content with the following code:

[source,java]
----
include::{sourcesdir}/chart/Column3dChart.java[]
----

The `init(Map<String, Object> params)` method populates the `countryGrowthDs` datasource with the data. The `refresh()` method initializes the datasource. This method should be invoked regardless of the `refreshMode="NEVER"` attribute declared in the XML-descriptor.

[[cdb_result]]
===== Result

. Open the *Open web menu* link at the bottom of the *GENERIC UI* section in CUBA Studio.

. Make sure the `application` menu contains new `column3d-chart` item. New screen are added to the menu automatically if created in Studio.

. Select *Run* -> *Start application server*.

After logging in and opening the screen from the application menu you will see the chart like below:

.Column 3D Chart
image::chart/column3d-chart.svg[align="center", width="800"]

[[chart_with_data_provider]]
==== Creating Chart with Data from DataProvider

This chart retrieves data through the `DataProvider` created in the controller, so the `datasource` attribute is not defined.

[[cdp_creating_chart]]
===== Creating Chart

[[cdp_xml_descriptor]]
====== Screen XML Descriptor

Open the *Screens* tab in CUBA Studio and create a screen in the *web* module. Enter the value `com/company/sampler/web/screens/stackedarea-chart.xml` in the *Descriptor* field. The fields - *Id*, *Controller Name*
and *Messages Pack* will be filled in with appropriate values. Save changes. Open the *XML* tab and replace its content with the following code:

[source, xml]
----
include::{sourcesdir}/chart/stackedarea-chart.xml[]
----

The root element of the screen descriptor contains a new `xmlns:chart` attribute:

[source, xml]
----
<window xmlns:chart="http://schemas.haulmont.com/charts/charts.xsd"
    ...
>
----

`chart:serialChart` attributes:

* `categoryField` - a key from the set of pairs contained in the `DataItem` objects listed in a `DataProvider` instance; this key is used to determine the labels for the category axis.

The elements of `chart:serialChart`:

* `chart:chartCursor` - an optional element adding a cursor to the chart; the cursor follows the mouse pointer and shows a tooltip with the value of the corresponding point on a chart.
** The `cursorAlpha` attribute defines opacity of the cursor line.

* `chart:legend` - an element that defines the chart legend.
** The `position` attribute defines the location of the legend relative to the chart.
** The `equalWidths` attribute specifies if each of legend entry should be equal to the most wide entry.
** The `periodValueText` attribute defines the text which will be displayed in the value portion of the legend when user is not hovering above any data point. The tags should be made out of two parts - the name of a field (value / open / close / high / low) and the value of the period you want to be show - open / close / high / low / sum / average / count.
** The `valueAlign` attribute defines alignment of the value text. Possible values are "left" and "right".
** The `valueWidth` attribute defines width of the value text.

* `chart:valueAxes` - an element that defines vertical value axes. In our case, only one vertical axis is used; the axis is described by the `chart:axis` element.
** The `position` attribute defines position of the value axis relative to the chart.
** The `title` attribute defines the title of the value axis.
** Setting `stackType` to `REGULAR` makes the chart display a rolling value. Setting this attribute to `none` refers to a non-rolling value.
** The `gridAlpha` defines opacity of grid lines.

* `chart:graphs` - an element that contains the collection of `chart:graph` elements; the graph is described by the `chart:graph` element.
** The `type` attribute defines the type of the graph and can be: line, column, step line, smoothed line, ohlc and candlestick.
** The `valueField` attribute defines a key from the list of pairs contained in the `DataItem` objects listed in a `DataProvider` instance; this key is used to determine the value.
** The `fillAlphas` attribute defines opacity of fill.
** The `lineAlpha` attribute defines opacity the line (or column border). Value range is 0 - 1.
** The `hidden` attribute specifies whether the graph is hidden.

* `chart:categoryAxis` - an element that describes the category axis.
** Setting `startOnAxis` to `true` causes drawing the chart right from the value axis. The default value for this attribute is `false`. In this case, there will be a small gap between the value axis and the chart.
** The `gridAlpha` attribute defines opacity of grid lines.
** The `axisColor` attribute defines axis color.

* `chart:export` – an optional element that enables chart export.

[[cdp_screen_controller]]
====== Screen Controller

Open the *Controller* tab and replace its content with the following code:

[source,java]
----
include::{sourcesdir}/chart/StackedAreaChart.java[]
----

The `init(Map<String, Object> params)` method submits data to the chart as a rolling value. This type of charts shows the ratio of separate parts to their total value.

[[cdp_result]]
===== Result

. Open the *Main Menu* tab in CUBA Studio and click *edit* button for `web-menu.xml`.

. Choose *`application`* item and click *new* button.

. In *Create menu item* dialog choose `stackedarea-chart` for *id* field and click *add*.

. Select *Run* -> *Start application server*.

After logging in and opening the screen from the application menu you will see the chart like below:

.Stacked Area Chart
image::chart/stackedarea-chart.svg[align="center", width="800"]

[[section_incremental_data_update]]
==== Creating Chart with Incremental Data Update

This chart will retrieve data from a datasource, and this data will be updated automatically. When new data is added to the datasource, the chart is not refreshed completely: data points are added on the fly each 2 seconds. This approach will be useful, for example, for creating dynamically updated dashboards.

In this example we will show the dynamic of new orders amounts based on the `Order` entity from the https://github.com/cuba-platform/sample-sales[Sales] sample application.

. Download the *Sales* application and add the *charts* component to it as described in <<chart_project_setup>> section.

. Create a new screen in Studio. Call it *orders-history*, as it will display the history dashboard for new order entries.

. Add the `serialChart` component to the screen layout. To use the incremental data update feature, we have to create the `collectionDatasource` and bind the chart to it. We will not load the data from the database in this example, instead, the sample data will be generated on the fly, so you don't need to create a query.
+
Set the `date` property for the category axis and the `amount` property for the value axis.
+
[source, xml]
----
include::{sourcesdir}/chart/chart_incremental-update.xml[]
----

. We will update the chart on the fly using `timer` - a special UI component that will send HTTP-requests to the server side.
+
Open the *Properties* tab of the screen designer and add the timer by clicking on the *Timers* button. Set the timer *id*. Let's say the data should be updated each 2 seconds, so set the *delay* to 2000 milliseconds.
+
In the *onTimer* field we define the name of Java method - `updateChart`. This method will be invoked each time the timer fires an event. Generate this method in the controller by clicking the *>>* button and click *Apply* to save it.
+
.Creating a timer
image::chart/chart_incremental-update.png[align="center"]

. Switch to the IDE. Before starting to work on the timer logic, inject necessary dependencies: `timeSource`, `metadata`, and the datasource instance. We will generate a new `Order` instance with random amount value each time the timer event is fired. The new instance is added to the datasource using the `includeItem()` method.
+
Initialize the chart in the `init()` method using the same logic for creating a random `Order` instance.
+
[source, java]
----
include::{sourcesdir}/chart/chart_incremental-update.java[]
----
+
At this stage the chart is already functional, but the datasource size will increase rapidly, so we need to limit the number of items to be displayed.
+
.The data is automatically updated each 2 seconds
image::chart/chart_incremental-update_2.png[align="center"]

. Create a `Queue` of orders. Each time the timer event is fired, the generated item is added to the top of the `itemsQueue`. When the queue size exceeds 10 items, the oldest item is excluded.
+
[source, java]
----
private Queue<Order> itemsQueue = new LinkedList<>();
----
+
[source, java]
----
include::{sourcesdir}/chart/chart_incremental-update_2.java[]
----

'''

Result::

All the data is sent to the browser incrementally. If you open Chrome developer console on the *Network* tab, you will see that each 2 seconds our web page sends an HTTP request to the backend, and in response to that the backend sends very small JSON message. The JSON contains one `add` and one `remove` operation for the amount value. Thus, we do not re-send all the data.

.The chart shows only 10 records at a time
image::chart/chart_incremental-update_3.gif[align="center"]

'''

[[section_use_of_events]]
==== Using Events

Let us consider the use of events. We will add handling of a graph item click to the screen created in <<cdb_creating_chart>>. Open the screen controller in the IDE and inject the chart:

[source, java]
----
@Inject
private SerialChart serialChart;
----

Then add a listener at the bottom of the `init(Map<String, Object> params)` method. When a chart receives data from `DataProvider`, the `getDataItemNN()` method should be used to get the item clicked. In this example, the `SerialChart` component is bound to the datasource, so another method should be used: `getEntityNN()`:

[source,java]
----
include::{sourcesdir}/chart/GraphItemClickListener.java[]
----

To see the results, rebuild the project using *Run* -> *Restart application server* and log in to the system. Open the screen and click one of the columns.

.Chart that handles graph item click event
image::chart/chart-with-event.png[align="center", width="800", height="367"]

[[custom_json]]
==== Configuration using JSON

In order to configure a chart, in addition to assigning XML attributes, you can use a custom JSON described in the http://docs.amcharts.com/3/javascriptcharts[AmCharts documentation].

For example, we have a serial chart:

[source, xml]
----
include::{sourcesdir}/chart/custom_json_1.xml[]
----

This chart have some data:

[source,java]
----
include::{sourcesdir}/chart/custom_json_2.java[]
----

image::chart/chart_custom_json.png[align="center"]

And now we can change the chart's configuration. As an example, let's add a title:

[source,java]
----
include::{sourcesdir}/chart/custom_json_3.java[]
----

image::chart/chart_custom_json_title.png[align="center"]

You can also set JSON configuration in the XML:

[source, xml]
----
include::{sourcesdir}/chart/custom_json_4.xml[]
----

[[chart_replacement]]
=== Replacing AmCharts Version

An instance of AmCharts library included in CUBA platform can be replaced with another one. To do this:

. Download charts and stock charts from https://www.amcharts.com/download/[AmCharts site^].
. Merge `amcharts` folder from both archives into one.
. Copy `amcharts` folder to `{project.rootDir}/modules/web/web/VAADIN/webjars`
. Redeploy the application.

To use new attributes added in a new version you need to set custom JSON in your screen controller as shown below.

[source, java]
----
chart.setNativeJson("{\"valueScrollbar\":{\"autoGridCount\":true}}");
----
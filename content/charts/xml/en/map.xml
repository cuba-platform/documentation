<?xml version='1.0' encoding='UTF-8'?>
<!-- This document was created with Syntext Serna Free. --><chapter id="map" lang="en">
  <title>Displaying Maps</title>
  <para>CUBA platform map display subsystem is based on integration with a third-party map service provider. Currently, only Google Maps service is supported.</para>
  <section id="map_features">
    <title>Map Display Capabilities</title>
    <itemizedlist>
      <listitem>
        <para>Response to events:<itemizedlist>
            <listitem>
              <para>Mouse click.</para>
            </listitem>
            <listitem>
              <para>Map pan and zoom.</para>
            </listitem>
            <listitem>
              <para>Marker click and drag.</para>
            </listitem>
            <listitem>
              <para>Close pop-up window.</para>
            </listitem>
          </itemizedlist></para>
        <mediaobject>
          <imageobject>
            <imagedata fileref="img/map/map_demo_click.png" align="center"/>
          </imageobject>
        </mediaobject>
      </listitem>
      <listitem>
        <para>Adding markers. Marker may be either fixed or draggable by user. Markers can process mouse clicks and send corresponding events to the screen code.<mediaobject>
            <imageobject>
              <imagedata fileref="img/map/map_demo_marker.png" align="center"/>
            </imageobject>
          </mediaobject></para>
      </listitem>
      <listitem>
        <para>Displaying polylines and polygons.<mediaobject>
            <imageobject>
              <imagedata fileref="img/map/map_demo_polygon_display.png" align="center"/>
            </imageobject>
          </mediaobject></para>
      </listitem>
      <listitem>
        <para>Drawing  polygons.<mediaobject>
            <imageobject>
              <imagedata fileref="img/map/map_demo_polygon_draw.png" align="center"/>
            </imageobject>
          </mediaobject></para>
      </listitem>
      <listitem>
        <para>Heat map rendering.<mediaobject>
            <imageobject>
              <imagedata fileref="img/map/map_demo_heatmap.png" align="center"/>
            </imageobject>
          </mediaobject></para>
      </listitem>
    </itemizedlist>
  </section>
  <section id="map_project_setup">
    <title>Setting up Application Project</title>
    <para>In order to display maps in your application, you should include the <structname>charts</structname> base project, as it was  <link linkend="chart_project_setup">described</link> for the chart display subsystem. Additionally, you should define the following application properties for the <structname>Web Client</structname> block:<itemizedlist>
        <listitem>
          <para>Mandatory parameter – map service API access key. For a free key use the <code>cuba.charts.map.freeApiKey</code> property. For a commercial license, the following properties should be defined:<itemizedlist>
              <listitem>
                <para><code>cuba.charts.map.useBusinessApiKey = true</code> - commercial key flag.</para>
              </listitem>
              <listitem>
                <para><code>cuba.charts.map.businessApiKey</code> - API key.</para>
              </listitem>
              <listitem>
                <para><code>cuba.charts.map.clientId</code> - client identifier, may be mandatory depending on the map service provider. Mandatory for Google Maps.</para>
              </listitem>
            </itemizedlist></para>
        </listitem>
        <listitem>
          <para>Optional parameters:<itemizedlist>
              <listitem>
                <para><code>cuba.charts.map.defaultZoom</code> - default zoom level for the map.</para>
              </listitem>
              <listitem>
                <para><code>cuba.charts.map.defaultLatitude</code> - default latitude of the map center point.  </para>
              </listitem>
              <listitem>
                <para><code>cuba.charts.map.defaultLongitude</code> - default longitude of the map center point.</para>
              </listitem>
              <listitem>
                <para><code>cuba.charts.map.provider</code> - map service provider,  <code>google</code> by default.</para>
              </listitem>
            </itemizedlist></para>
        </listitem>
      </itemizedlist></para>
    <para>Example of a  <filename>web-app.properties</filename> file:<programlisting>cuba.charts.map.freeApiKey = my_key
cuba.charts.map.defaultZoom = 13.0
cuba.charts.map.defaultLatitude = 51.5001
cuba.charts.map.defaultLongitude = -0.1262</programlisting> </para>
  </section>
  <section id="mapViewer">
    <title>MapViewer Component</title>
    <para>You can display maps in your application screens using the <code>com.haulmont.charts.gui.components.map.MapViewer</code> component. </para>
    <para>To add the component, declare the <code>chart</code> namespace in the root element of the screen XML descriptor:<programlisting language="xml">&lt;window xmlns=&quot;http://schemas.haulmont.com/cuba/5.5/window.xsd&quot;
        xmlns:chart=&quot;http://schemas.haulmont.com/charts/5.5/charts.xsd&quot;
        ...&gt;</programlisting></para>
    <para>XML-name of the component: <code>mapViewer</code>. Component declaration example:<programlisting language="xml">&lt;layout&gt;
    &lt;vbox id=&quot;mapBox&quot; height=&quot;100%&quot;&gt;
        &lt;chart:mapViewer id=&quot;map&quot; width=&quot;100%&quot; height=&quot;100%&quot;/&gt;
    &lt;/vbox&gt;
&lt;/layout&gt;</programlisting></para>
    <para>You can define the following component parameters in the screen XML-descriptor:<itemizedlist>
        <listitem>
          <para><code>id</code>, <code>width</code>, <code>height</code> - standard component properties.</para>
        </listitem>
        <listitem>
          <para><code>mapType</code> - map type corresponding to the  <code>MapViewer.Type</code>: <code>roadmap</code>, <code>satellite</code>, <code>hybrid</code>, <code>terrain</code>. Default is  <code>roadmap</code>.</para>
        </listitem>
        <listitem>
          <para><code>vendor</code> - map service provider. Currently the only supported value is  <code>google</code>.</para>
        </listitem>
      </itemizedlist></para>
    <para>Main configuration of the map and its components is performed in a screen controller. For this, you only need to inject the component declared in the XML-descriptor:<programlisting language="java">@Inject
private MapViewer map;

@Override
public void init(Map&lt;String, Object&gt; params) {
    GeoPoint center = map.createGeoPoint(53.490905, -2.249558);
    map.setCenter(center);
}</programlisting></para>
    <itemizedlist>
      <listitem>
        <para>Map configuration methods:<itemizedlist>
            <listitem>
              <para><code>setZoom()</code> - sets the map zoom level.</para>
            </listitem>
            <listitem>
              <para><code>setCenter()</code> - sets the map center point.</para>
            </listitem>
            <listitem>
              <para><code>setVisibleAreaBoundLimitsEnabled()</code> - enables visible area limitation mode.</para>
            </listitem>
            <listitem>
              <para><code>setVisibleAreaBoundLimits()</code> - sets boundaries of the visible area of the map.</para>
            </listitem>
            <listitem>
              <para><code>fitToBounds()</code> - sets the minimum map zoom as the one which will be sufficient to show in full an area limited by north-eastern and south-western coordinates.</para>
            </listitem>
            <listitem>
              <para><code>setMaxZoom()</code> - sets the maximum available zoom level.</para>
            </listitem>
            <listitem>
              <para><code>setMinZoom()</code> - sets the minimum available zoom level.</para>
            </listitem>
            <listitem>
              <para><code>setDraggable()</code> - enables/disables map dragging mode.</para>
            </listitem>
            <listitem>
              <para><code>setKeyboardShortcutsEnabled()</code> - enables/disables keyboard shortcuts.</para>
            </listitem>
            <listitem>
              <para><code>setScrollWheelEnabled()</code> - enables/disables map zoom with a mouse scroll wheel.</para>
            </listitem>
            <listitem>
              <para><code>setMapType()</code> - defines map type.</para>
            </listitem>
          </itemizedlist></para>
      </listitem>
      <listitem>
        <para>Map component interfaces (can be found in  <code>com.haulmont.charts.gui.map.model</code> package):<itemizedlist>
            <listitem>
              <para><code>GeoPoint</code> - an auxiliary component, which is not displayed on the map. This component can be used to set such map parameters as the center point, boundaries, or to create more complex map components. The object can be created using the  <code>createGeoPoint()</code>method of the  <code>MapViewer</code> interface. For example:<programlisting language="java">GeoPoint center = map.createGeoPoint(53.490905, -2.249558);
map.setCenter(center);</programlisting></para>
            </listitem>
            <listitem>
              <para><code>Marker</code> - a component that marks a location on the map. By default, a standard icon of the map service vendor is used. You can use the  <code>createMarker()</code> and  <code>addMarker()</code>methods of the <code>MapViewer</code> interface to create this object and put it on a map. For example:<programlisting language="java">Marker marker = map.createMarker(&quot;My place&quot;, map.createGeoPoint(53.590905, -2.249558), true);
marker.setClickable(true);
map.addMarker(marker);</programlisting></para>
            </listitem>
            <listitem>
              <para><code>Polyline</code> - a component that displays a polyline. You can use the  <code>createPolyline()</code> and  <code>addPolyline()</code> methods of the  <code>MapViewer</code> interface to create this object and put it on a map. For example:<programlisting language="java">List&lt;GeoPoint&gt; coordinates = new ArrayList&lt;&gt;();
coordinates.add(map.createGeoPoint(53.49, -2.54));
coordinates.add(map.createGeoPoint(53.49, -2.22));
coordinates.add(map.createGeoPoint(53.89, -2.22));
coordinates.add(map.createGeoPoint(53.99, -2.94));
Polyline polyline = map.createPolyline(coordinates);
map.addPolyline(polyline);</programlisting></para>
            </listitem>
            <listitem>
              <para><code>Polygon</code> - a component that displays a polygon. You can use the <code>createPolygon()</code> and <code>addPolygonOverlay()</code> methods of the <code>MapViewer</code> interface to create this object and put it on a map. For example:<programlisting language="java">List&lt;GeoPoint&gt; coordinates = new ArrayList&lt;&gt;();
coordinates.add(map.createGeoPoint(53.49, -2.54));
coordinates.add(map.createGeoPoint(53.49, -2.22));
coordinates.add(map.createGeoPoint(53.89, -2.22));
coordinates.add(map.createGeoPoint(53.99, -2.94));
Polygon p = map.createPolygon(coordinates, &quot;#9CFBA9&quot;, 0.6, &quot;#2CA860&quot;, 1.0, 2);
map.addPolygonOverlay(p);</programlisting></para>
            </listitem>
            <listitem>
              <para><code>InfoWindow</code> - a map component that displays information in a pop-up window. You can use the <code>createInfoWindow()</code> and <code>openInfoWindow()</code> methods of the <code>MapViewer</code> interface to create this object and put it on a map. For example:
<programlisting language="java">InfoWindow w = map.createInfoWindow(&quot;Some text&quot;);
map.openInfoWindow(w);</programlisting></para>
              <para>Information window can be tied to a marker, for example:<programlisting language="java">map.addMarkerClickListener(new MarkerClickListener() {
    @Override
    public void onClick(MarkerClickEvent event) {
        Marker marker = event.getMarker();
        String caption = String.format(&quot;Marker clicked: %.2f, %.2f&quot;, 
                marker.getPosition().getLatitude(),
                marker.getPosition().getLongitude());
        InfoWindow w = map.createInfoWindow(caption, marker);
        map.openInfoWindow(w);
    }
});</programlisting></para>
            </listitem>
            <listitem>
              <para><code>HeatMapLayer</code> - a map layer showing a heat map intended to display data density distribution across different geopoints. Data density is highlighted with color. By default, regions with higher points density are displayed in red and regions with lower density – in green. You can use the <code>createHeatMapLayer()</code> and  <code>addHeatMapLayer()</code> methods of the <code>MapViewer</code> interface to create this object and put it on a map. For example: <programlisting language="java">HeatMapLayer heatMapLayer = map.createHeatMapLayer();
List&lt;GeoPoint&gt; data = new ArrayList&lt;&gt;();
data.add(map.createGeoPoint(53.450, -2.00));
data.add(map.createGeoPoint(53.451, -2.00));
data.add(map.createGeoPoint(53.452, -2.00));
data.add(map.createGeoPoint(53.453, -2.00));
data.add(map.createGeoPoint(53.454, -2.00));        
heatMapLayer.setData(data);
map.addHeatMapLayer(heatMapLayer);</programlisting></para>
              <para>The data used for the heat map layer can be changed using a separate  <code>setData()</code> method. This change does not require re-adding the layer to the map. </para>
            </listitem>
            <listitem>
              <para><code>DrawingOptions</code> - auxiliary drawing component. Only polygon drawing is currently supported. Drawing mode can be enabled by passing an instance of <code>DrawingOptions</code> to the <code>MapViewer</code>. Example:<programlisting language="java">DrawingOptions options = new DrawingOptions();
PolygonOptions polygonOptions = new PolygonOptions(true, true, &quot;#993366&quot;, 0.6);
ControlOptions controlOptions = new ControlOptions(
    Position.TOP_CENTER, Arrays.asList(OverlayType.POLYGON));
options.setEnableDrawingControl(true);
options.setPolygonOptions(polygonOptions);
options.setDrawingControlOptions(controlOptions);
options.setInitialDrawingMode(OverlayType.POLYGON);
map.setDrawingOptions(options);</programlisting></para>
            </listitem>
          </itemizedlist></para>
      </listitem>
      <listitem>
        <para>Event listeners (located in the <code>com.haulmont.charts.gui.map.model.listeners</code>) package):<itemizedlist>
            <listitem>
              <para><code>MapMoveListener</code> - user drags a map with a mouse button pressed.</para>
            </listitem>
            <listitem>
              <para><code>MapClickListener</code> - user clicks on a map.</para>
            </listitem>
            <listitem>
              <para><code>MarkerClickListener</code> - user clicks on a marker.</para>
            </listitem>
            <listitem>
              <para><code>MarkerDragListener</code> - user drags a marker.</para>
            </listitem>
            <listitem>
              <para><code>InfoWindowClosedListener</code> - user closes an information window.</para>
            </listitem>
            <listitem>
              <para><code>PolygonCompleteListener</code> - user creates a polygon in map editing mode.</para>
            </listitem>
            <listitem>
              <para><code>PolygonEditListener</code> - user edits a polygon (moves or adds a vertex to an existing polygon).</para>
            </listitem>
            <listitem>
              <para><code>MapInitListener</code> - map initialization complete. This listener is invoked once after the first load of the map when all the tiles are loaded and coordinates are available.</para>
            </listitem>
          </itemizedlist></para>
      </listitem>
    </itemizedlist>
    <para>For a more detailed information about the methods and parameters of map components, please refer to the corresponding JavaDocs.</para>
  </section>
</chapter>

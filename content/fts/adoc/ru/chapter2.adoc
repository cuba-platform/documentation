[[quick_start]]
== Быстрый старт

В данной главе мы рассмотрим применение подсистемы полнотекстового поиска в приложении-примере *Библиотека*, который может быть загружен с помощью CUBA Studio.

Разобьем задачу на следующие этапы:

. Подключим функциональность поиска к проекту, настроим вызов процесса индексирования и убедимся в его работоспособности.

. Настроим конфигурационный файл FTS для работы с сущностями модели данных примера *Библиотека*.

. Для иллюстрации возможностей поиска по загруженным файлам используем сущность `BookPublication` и функциональность загрузки файлов, описанную в разделе https://doc.cuba-platform.com/manual-latest/file_storage.html[*Хранилище файлов*] в https://doc.cuba-platform.com/manual-latest-ru/index.html[Руководстве по разработке приложений].

[[qs_project_setup]]
=== Настройка проекта

. Запустите *CUBA Studio*, перейдите в окно *Open project > Samples* и загрузите проект Library.

. Откройте проект Library в Studio.

. Откройте окно свойств проекта *Project properties* -> *Edit* и в списке *App components* включите компонент *fts*, затем сохраните изменения. Studio предложит пересоздать скрипты Gradle - согласитесь.

. Запустите *Run* -> *Deploy*. На этом этапе будет произведена сборка приложения и оно будет развернуто на сервере Tomcat в подкаталоге `build/tomcat`.

. Создайте базу данных приложения: *Run* -> *Create database*.

. Запустите сервер приложения: *Run* -> *Start application server*. 

. Откройте веб-интерфейс приложения по адресу `++http://localhost:8080/app++`. Войдите в систему с именем `*admin*` и паролем `*admin*`.

. Для того, чтобы включить функциональность полнотекстового поиска, в главном меню приложения откройте *Administration* -> *Application properties*, найдите и откройте список *`fts`* в таблице свойств, двойным щелчком откройте атрибут *fts.enabled* и выберите *true* в поле флажок *Current value*.
+
image::fts_enabled_true.png[align="center"]

После выполнения вышеописанных действий функциональность полнотекстового поиска подключена к приложению и готова к работе. Если выйти из системы и снова выполнить логин, в правой части верхней панели главного окна приложения появится поле поиска. Кроме того, полнотекстовый поиск может использоваться в UI-компоненте link:{main_man_url}/gui_Filter.html[Filter].

Однако поиск не будет давать результатов, так как никакие данные еще не проиндексированы.

Для однократного запуска индексации текущего состояния базы данных (а точнее, сущностей, описанных в конфигурационном файле FTS по умолчанию), откройте в главном меню *Administration* -> *JMX Console*, найдите JMX-бин `app-core.fts:type=FtsManager` и вызовите последовательно сначала метод `reindexAll()`, а затем `processQueue()`.

image::jmx_fts_setup.png[align="center"]

После этого поиск, например, строки "adm" должен выдавать следующие результаты:

image::2.1_project_setup.png[align="center"]

[[qs_indexing]]
=== Настройка вызова процесса индексирования

Для периодического вызова процесса индексирования удобно воспользоваться механизмом назначенных заданий платформы (см. *Руководство по разработке приложений* -> https://doc.cuba-platform.com/manual-latest/scheduled_tasks_cuba.html[*Назначенные задания CUBA*]).

Сначала необходимо активировать весь механизм запуска задач. Добавьте в файл `app.properties` модуля *core* проекта приложения следующее свойство:

[source, properties]
----
cuba.schedulingActive = true
----

Перезапустите сервер приложения, войдите в систему пользователем `*admin*`, откройте экран *JMX Console*, найдите и откройте JMX-бин `app-core.cuba:type=Scheduling` и убедитесь, что атрибут *Active* имеет значение `true`. 

Далее откройте экран *Administration* -> *Scheduled Tasks*, нажмите *Create* и задайте следующие значения атрибутов новой задачи:

* *Defined by*: Bean

* *Bean name*: cuba_FtsManager

* *Method name*: processQueue()

* *Singleton*: true

* *Period, sec*: 30

Сохраните задачу, выделите ее в таблице и нажмите *Activate*. С этого момента каждые 30 секунд будет вызываться процесс индексирования измененных сущностей.

[WARNING]
====
Автоматическое индексирование не затрагивает сущности, созданные до его запуска. Для постановки таких сущностей в очередь на индексацию воспользуйтесь методами `reindexAll()` или `asyncReindexAll()` JMX-бина `app-core.fts:type=FtsManager`. Подробнее см. <<reindex>>.
====

[[qs_conf]]
=== Настройка файла конфигурации


При добавлении базового проекта `fts` в модуле *core* создаётся новый файл `fts.xml`. Проверьте его содержимое и при необходимости отредактируйте, включив в него те сущности, которые должны участвовать в полнотекстовом поиске.

[source, xml]
----
<fts-config>
    <entities>

        <entity class="com.sample.library.entity.Author">
            <include re=".*"/>
        </entity>

        <entity class="com.sample.library.entity.Book">
            <include re=".*"/>
        </entity>

        <entity class="com.sample.library.entity.BookInstance">
            <include re=".*"/>
        </entity>

        <entity class="com.sample.library.entity.BookPublication">
            <include re=".*"/>
        </entity>

        <entity class="com.sample.library.entity.LibraryDepartment">
            <include re=".*"/>
        </entity>

        <entity class="com.sample.library.entity.LiteratureType">
            <include re=".*"/>
        </entity>

        <entity class="com.sample.library.entity.Publisher">
            <include re=".*"/>
        </entity>

        <entity class="com.sample.library.entity.Town">
            <include re=".*"/>
        </entity>

    </entities>
</fts-config>
----

Это файл конфигурации FTS, в данном случае включающий в индексирование все сущности предметной области со всеми их атрибутами.

Добавьте в файл `app.properties` модуля *core* приложения следующее свойство:

[source, properties]
----
cuba.ftsConfig = +com/sample/library/fts.xml
----

В результате индексироваться будут и сущности, определенные в платформе в файле `cuba-fts.xml`, и описанные в файле проекта `fts.xml`.

Перезапустите сервер приложения. На данном этапе полнотекстовый поиск должен работать по всем сущностям модели приложения, а также по сущностям подсистемы безопасности платформы: `Role`, `Group`, `User`.

[[qs_search_files]]
=== Поиск по содержимому загруженных файлов

Теперь добавим функциональность загрузки файлов для каждой публикации и их отображение на экране списка сущности `BookPublication`.

Для начала необходимо внести изменения в `BookPublication`. Добавьте новый атрибут `file`, который будет являться ссылкой на сущность `FileDescriptor` с отношением много-к-одному. `FileDescriptor` - это описатель загруженного файла (не путать с `java.io.FileDescriptor`), позволяющий ссылаться на файл из объектов модели данных. После сохранения изменений добавьте новый атрибут к существующему представлению `bookPublication.full` и экранам просмотра списка и редактирования сущности `BookPublication` с помощью Studio.

image::book_publication_new_attribute.png[align="center"]

Сгенерируйте новые скрипты обновления БД, выполните команду обновления базы данных и перезапустите сервер приложения. При пересоздании базы данных полнотекстовый поиск по умолчанию отключается. Снова включите флажок *Value* для атрибута *Enable* в экране *JMX Console*, выполните индексацию всех файлов, выйдите из системы снова выполните логин.

Так как мы добавили новый атрибут, в таблице публикаций на экране списка сущности `BookPublication` теперь появился новый пустой столбец: *File*. Чтобы его заполнить, откройте экран редактирования строки таблицы, с помощью нового поля File загрузите  текстовый файл в систему и нажмите OK. По умолчанию CUBA поддерживает следующие форматы файлов: `RTF`, `TXT`, `DOC`, `DOCX`, `XLS`, `XSLX`, `ODT`, `ODS` и `PDF`.

image::book_publication_file_is_not.png[align="center"]

Новые файлы теперь отображаются в таблице. Внешний вид таблицы можно отредактировать.

image::book_publication_files_uploaded.png[align="center"]

Чтобы переиндексировать имеющиеся в базе данных сущности и файлы в соответствии с новой конфигурацией поиска, откройте в экране *JMX Console* JMX-бин `app-core.fts:type=FtsManager` и вызовите последовательно сначала метод `reindexAll()`, а затем `processQueue()`. Все вновь добавляемые и изменяемые данные будут индексироваться автоматически, с задержкой, определяемой интервалом вызова назначенного задания, т.е. не более 30 секунд.

В результате, *полнотекстовый поиск* будет выводить все результаты, включая вхождения в содержимом загруженных файлов.

image::book_publication_fts_result.png[align="center"]

Более подробную информацию о `FileStorageAPI` и `FileDescriptor` вы можете найти в соответствующих разделах основного руководства.

[[reindex]]
=== Запуск и настройка переиндексации сущностей

Если полнотекстовый поиск был подключен в момент, когда в систему уже внесены какие-либо данные, то эти данные нужно проиндексировать. Добавление записей в очередь на индексацию осуществляется с помощью методов JMX-бина `app-core.fts:type=FtsManager`. Удобный способ вызвать метод JMX-бина это воспользоваться экраном *JMX Console* пункта меню *Администрирование*.

JMX-бин `app-core.fts:type=FtsManager` предоставляет два метода для постановки сущностей в очередь на индексацию:

* `reindexAll()` - синхронно добавляет все сущности, описанные в файле конфигурации FTS, в очередь на индексацию. При больших объемах данных этот процесс может занять длительное время, и в этом случае рекомендуется воспользоваться методом `asyncReindexAll()`.

* `asyncReindexAll()` - сущности добавляются в очередь на индексацию пакетами с помощью метода `FtsManager.reindexNextBatch()`. Размер пакета задается конфигурационным параметром <<chapter2.adoc#fts.reindexBatchSize,fts.reindexBatchSize>>. Метод `FtsManager.reindexNextBatch()` должен вызываться механизмом назначенных заданий или с помощью планировщика Spring. Пока формирование очереди не завершено, индексация не производится.

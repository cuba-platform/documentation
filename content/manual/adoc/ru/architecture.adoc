[[architecture]]
=== Архитектура

В данной главе рассмотрена архитектура CUBA-приложений в различных разрезах: по уровням, блокам, модулям и компонентам.

[[app_tiers]]
==== Уровни и блоки приложения

Платформа позволяет строить приложения по классической трехуровневой схеме: клиентский уровень, средний слой, база данных. _Уровень_ отражает степень "удаленности" от хранимых данных. 

В дальнейшем речь пойдет в основном о среднем слое и клиентах, поэтому для краткости выражение "все уровни" означает два этих уровня.

На каждом уровне возможно создание одного или нескольких _блоков_ (units) приложения. Блок представляет собой обособленную исполняемую программу, взаимодействующую с другими блоками приложения. Средства платформы CUBA позволяют создавать блоки в виде веб-приложений и десктопных приложений.

.Уровни и блоки приложения
image::AppTiers.png[align="center"]

Middleware:: 
Средний слой, содержащий основную бизнес-логику приложения и выполняющий обращения к базе данных. Представляет собой отдельное веб-приложение под управлением стандартного контейнера <<javaee_web_profile,Java EE Web Profile>>. См. <<middleware>>.

Web Client:: 
Основной блок клиентского уровня. Содержит интерфейс, предназначенный, как правило, для внутренних пользователей организации. Представляет собой отдельное веб-приложение под управлением стандартного контейнера Java EE Web Profile. Реализация пользовательского интерфейса основана на фреймворке *Vaadin*. См. <<gui_framework>>.

Desktop Client:: 
Дополнительный блок клиентского уровня. Содержит интерфейс, предназначенный, как правило, для внутренних пользователей организации. Представляет собой десктопное Java-приложение, реализация пользовательского интерфейса основана на фреймворке *Java Swing*. См. <<gui_framework>>.

Web Portal:: 
Дополнительный блок клиентского уровня. Может содержать интерфейс для внешних пользователей и средства интеграции с мобильными устройствами и сторонними приложениями. Представляет собой отдельное веб-приложение под управлением стандартного контейнера Java EE Web Profile. Реализация пользовательского интерфейса основана на фреймворке *Spring MVC*. См. <<portal>>.

Polymer Client:: Дополнительный клиентский блок на чистом JavaScript, предоставляющий интерфейс для внешних пользователей. Основан на фреймворке https://www.polymer-project.org[Google Polymer], работает со средним слоем через <<rest_api_v2,REST API>>, запущенный в блоке Web Client или Web Portal. См. <<polymer_ui>>.

Обязательным блоком любого приложения является средний слой - *Middleware*. Для реализации пользовательского интерфейса, как правило, используется один или несколько клиентских блоков, например, *Web Client* и *Web Portal*.

Все основанные на Java клиентские блоки взаимодействуют со средним слоем одинаковым образом посредством протокола HTTP, что позволяет размещать средний слой произвольным образом, в том числе за сетевым экраном. Следует отметить, что при развертывании в простейшем случае среднего слоя и веб-клиента на одном сервере между ними организуется локальное взаимодействие в обход сетевого стека для снижения накладных расходов.

[[app_modules]]
==== Модули приложения

Модуль – наименьшая структурная единица CUBA-приложения. Представляет собой один модуль проекта приложения и соответствующий ему JAR файл с исполняемым кодом.

Стандартные модули: 

* *global* – включает в себя классы сущностей, интерфейсы сервисов и другие общие для всех уровней классы. Используется во всех <<app_tiers,блоках приложения>>.

* *core* – реализация сервисов и всех остальных компонентов среднего слоя. Используется только на *Middleware*.

* *gui* – общие компоненты <<gui_framework>>. Используется в *Web Client* и *Desktop Client*.

* *web* – реализация универсального пользовательского интерфейса на *Vaadin*, а также другие специфичные для веб-клиента классы. Используется в блоке *Web Client*.

* *desktop* – опциональный модуль – реализация универсального пользовательского интерфейса на *Java Swing*, а также другие специфичные для десктоп-клиента классы. Используется в блоке *Desktop Client*.

* *portal* – опциональный модуль – реализация веб-портала на *Spring MVC*. 

* *polymer-client* – опциональный модуль – реализация <<polymer_ui>> на JavaScript.

.Модули приложения
image::AppModules.png[align="center"]

[[app_components]]
==== Компоненты приложения

Функциональность платформы разделена на несколько _компонентов приложения_ (ранее называемых _базовыми проектами_):

* *cuba* – основной компонент, содержит всю функциональность, описанную в данном руководстве.

* *reports* – подсистема генерации отчетов.

* *fts* – подсистема полнотекстового поиска.

* *charts* – подсистема вывода диаграмм.

* *bpm* – механизм исполнения бизнес-процессов по стандарту BPMN 2.0.

Проект приложения всегда зависит от одного или нескольких компонентов. Это означает, что приложение использует компоненты как библиотеки и включает их функциональность.

Любое CUBA-приложение зависит от компонента *cuba*. Остальные компоненты платформы являются опциональными и могут быть включены в приложение при необходимости. Все опциональные компоненты зависят от *cuba* и могут также иметь зависимости между собой.

Ниже приведена диаграмма зависимостей между компонентами платформы. Сплошными линиями изображены обязательные зависимости, пунктирными − опциональные.

image::BaseProjects.png[align="center"]

Любое CUBA-приложение может в свою очередь быть использовано как компонент другого приложения. Это позволяет декомпозировать большие проекты в наборы функциональных модулей, которые могут разрабатываться независимо. Можно также создать в организации набор собственных компонентов  использовать их в различных проектах, тем самым создав собственную платформу более высокого уровня на основе CUBA. Ниже приведена диаграмма возможной структуры зависимостей компонентов приложения.

image::AppComponents2.png[align="center"]

Для того чтобы приложение можно было использовать в качестве компонента, оно должно содержать дескриптор <<app-component.xml,app-component.xml>> и специальный элемент в манифесте JAR модуля *global*. CUBA Studio позволяет автоматически сгенерировать дескриптор и манифест для текущего проекта.

Практическое руководство по работе с собственным компонентом приложения приведено в разделе <<app_components_sample,>>.

[[app_structure]]
==== Состав приложения

Вышеописанные архитектурные принципы напрямую отражаются на составе собранного приложения. Рассмотрим его на примере простого приложения *sales*, которое имеет два блока – *Middleware* и *Web Client*; и включает в себя функциональность компонентов *cuba* и *reports*.

.Состав простого приложения
image::SampleAppArtifacts.png[align="center"]

На рисунке изображено содержимое некоторых каталогов сервера *Tomcat* с развернутым в нем приложением *sales*. 

<<app_tiers,Блок>> *Middleware* реализован веб-приложением `app-core`, блок *Web Client* – веб-приложением `app`. Исполняемый код веб-приложений содержится в каталогах `WEB-INF/lib` в наборе JAR-файлов. Каждый JAR представляет собой результат сборки (<<artifact,артефакт>>) одного из <<app_modules,модулей>> приложения или <<app_components,базового проекта>>.

Например, состав JAR-файлов веб-приложения среднего слоя `app-core` определяется тем, что блок *Middleware* состоит из модулей *global* и *core*, и приложение использует компоненты *cuba* и *reports*.


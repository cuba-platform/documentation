:sourcesdir: ../../../source

[[images_recipe]]
=== Загрузка и вывод изображений

Рассмотрим задачу загрузки, хранения и отображения фотографий сотрудников:

* Сотрудник представлен сущностью `Employee`.

* Файлы изображений хранятся в <<file_storage,FileStorage>>. Сущность `Employee` содержит ссылку на соответствующий `FileDescriptor`.

* Экран редактирования `Employee` отображает фотографию, а также дает возможность загрузить, выгрузить и очистить изображение.

Класс сущности со ссылкой на файл изображения:

[source, java]
----
include::{sourcesdir}/cookbook/images_1.java[]
----

<<views,Представление>> для загрузки `Employee` вместе с `FileDescriptor` должно содержать все локальные атрибуты `FileDescriptor`:

[source, xml]
----
include::{sourcesdir}/cookbook/images_2.xml[]
----

Фрагмент XML-дескриптора экрана редактирования `Employee`:

[source, xml]
----
include::{sourcesdir}/cookbook/images_3.xml[]
----

Компоненты отображения и загрузки/выгрузки фотографии заключены внутрь контейнера <<gui_GroupBoxLayout,groupBox>>. В верхней его части с помощью компонента <<gui_Image,image>> выводится изображение, а в нижней слева направо расположены компонент <<gui_FileUploadField,upload>> для загрузки файла и <<gui_Button,кнопки>> выгрузки и очистки изображения. В результате эта часть экрана должна выглядеть следующим образом:

image::images_recipe.png[align="center"]

Теперь рассмотрим <<screen_controllers,контроллер>> экрана редактирования>>.

[source, java]
----
include::{sourcesdir}/cookbook/images.java[]
----

<1> В методе `init()` сначала инициализируется компонент `uploadField`, предназначенный для загрузки новой фотографии.

<2> В случае успешной загрузки из компонента получается экземпляр нового `FileDescriptor`, и соответствующий файл отправляется из временного хранилища в постоянное вызовом `FileUploadingAPI.putFileIntoStorage()`.

<3> После этого `FileDescriptor` сохраняется в БД вызовом <<dataManager,DataManager.commit()>>, и сохраненный экземпляр устанавливается в атрибуте `imageFile` редактируемой сущности `Employee`.

<4> Затем вызывается метод `displayImage()` контроллера для отображения загруженной фотографии.

<5> Далее источнику данных, содержащему редактируемый экземпляр `Employee`, добавляется слушатель для запрещения или разрешения кнопок выгрузки и очистки файла в зависимости от того, загружен файл или нет.

<6> Метод `onAfterShow()` вызывает отображение файла и обновляет состояние кнопок в зависимости от наличия загруженного файла.

<7> Метод `onDownloadImageBtnClick()` вызывается при нажатии кнопки `downloadImageBtn` и выполняет выгрузку файла с помощью интерфейса <<file_download,ExportDisplay>>.

<8> Метод `onClearImageBtnClick()` вызывается при нажатии кнопки `clearImageBtn` и очищает атрибут `imageFile` сущности `Employee`. Удаления файла из хранилища не производится.

<9> Метод `displayImage()` выгружает файл из хранилища и устанавливает его в качестве содержимого компонента `image`.

include::images_recipe/images_in_table.adoc[]


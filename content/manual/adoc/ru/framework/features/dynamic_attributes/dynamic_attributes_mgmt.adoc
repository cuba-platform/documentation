:sourcesdir: ../../../../../source

[[dynamic_attributes_mgmt]]
===== Управление динамическими атрибутами

Управление категориями и описаниями атрибутов осуществляется с помощью экрана *Administration → Dynamic Attributes*. Данный экран отображает список категорий слева и список атрибутов выбранной категории справа.

Для того, чтобы создать динамический атрибут для некоторой сущности, сначала создайте для нее категорию. Флажок *Default* указывает, что данная категория будет автоматически выбрана для нового экземпляра сущности, если сущность реализует интерфейс `Categorized`. Если сущность не является `Categorized`, то значение флажка не используется, и можно завести как одну, так и несколько категорий для сущности - все их атрибуты будут отображаться в соответствии с <<dynamic_attributes_visibility,настройками видимости>>.

Для того чтобы изменения в атрибутах и настройках видимости вступили в силу, необходимо нажать кнопку *Применить изменения* на экране со списком категорий. Изменения также можно применить через *Administration → JMX Console*, вызвав метод `clearDynamicAttributesCache()` JMX бина `app-core.cuba:type=CachingFacade`.

Ниже приведен пример экрана редактирования категории:

.Экран редактирования категории
image::categoryEditor.png[align="center"]

Секция *Name localization* отображается на экране редактирования категории, если приложение поддерживает более одного языка, и позволяет задать локализованное значение имени категории для каждой доступной локали.

.Локализация имени категории
image::categoryLocalization.png[align="center"]

[[dynamic_attributes_mgmt_attr_location]]
На вкладке *Attributes Location* вы можете настроить расположение каждого динамического атрибута внутри <<categorized_entity,DynamicAttributesPanel>>.

.Настройка расположения атрибутов
image::dynamic_attributes_location.png[align="center"]

Укажите количество колонок в выпадающем списке *Columns count*. Перетащите атрибут из списка атрибутов в нужный столбец и нужную строку. Вы можете добавлять пустые ячейки и менять порядок отображения атрибутов. После внесения изменений нажмите на кнопку *Save configuration*.

Расположение атрибутов на панели `DynamicAttributesPanel` в редакторе сущности:

image::dynamic_attributes_location_rezult.png[align="center"]

Редактор динамического атрибута позволяет задать имя, системный код, описание, тип значения, значение атрибута по умолчанию и скрипт валидации.

.Редактор динамического атрибута
image::runtimePropertyEditor.png[align="center"]

Для всех типов значения, кроме `Boolean`, доступно поле *Width*, позволяющее задать ширину поля в `Form` в пикселах или процентах. Если поле *Width* не заполнено, его значение по умолчанию равно 100%.

Для всех типов значения, кроме `Boolean`, также доступен чекбокс *Is collection*. Он позволяет создавать динамические атрибуты выбранного типа со множеством значений.

Для всех числовых типов значений: `Double`, `Fixed-point number`, `Integer` – доступны следующие поля:

* *Minimum value* – при вводе значения атрибута просходит проверка, что значение должно быть больше или равно указанному минимальному значению.

* *Maximum value* – при вводе значения атрибута просходит проверка, что значение должно быть меньше или равно указанному максимальному значению.

Для типа значения `Fixed-point number` доступно поле **Number format pattern**, в котором можно задать паттерн форматирования. Паттерн задается по правилам, описанным в https://docs.oracle.com/javase/8/docs/api/java/text/DecimalFormat.html[DecimalFormat].

Для всех типов значений есть возможность указать скрипт валидации в поле **Validation script** для проверки значения, введенного пользователем. Логика валидации задается в скрипте Groovy. В случае неуспешной валидации Groovy скрипт должен вернуть сообщение об ошибке. В противном случае скрипт не должен возвращать ничего или может вернуть `null`. Проверяемое значение доступно в скрипте в переменной `value`. Для сообщения об ошибке используется Groovy строка, ключ `$value` может быть использован в сообщении для формирования результата.

Пример:

[source, groovy]
----
include::{sourcesdir}/features/dynamicAttrValidation.groovy[]
----

Для типа значения `Enumeration` множество значений перечисления задаётся в поле *Enumeration* в редакторе списка.

.Редактор динамического атрибута для типа значений `Enumeration`
image::runtimePropertyEnum.png[align="center"]

Каждое значение перечисления может быть локализовано на языки, доступные в приложении:

.Локализация динамического атрибута для типа значений `Enumeration`
image::runtimePropertyEnumLocalization.png[align="center"]

[[dynamic_attributes_lookupField]]
Для типов данных `String`, `Double`, `Entity`, `Fixed-point number` и `Integer` доступен чекбокс *Lookup field*. Если данный чекбокс установлен, то пользователь может выбирать значение атрибута из выпадающего списка. Список допустимых значений можно <<dynamic_attributes_optionsType,настроить>> на вкладке *Calculated values and options*. Для типа данных *Entity* настраиваются условия Where и Join.

Рассмотрим вкладку *Calculated values and options*. В поле *Attribute depends on* вы можете указать, от каких атрибутов зависит текущий атрибут. При изменении значения одного из этих атрибутов будет пересчитан либо скрипт для вычисления значения атрибута, либо скрипт для вычисления <<dynamic_attributes_optionsType,списка возможных значений>>.

Groovy скрипт для вычисления значения атрибута задается в поле *Recalculation value script*. Скрипт должен возвращать новое значение параметра. В скрипт передаются следующие переменные:

* `entity` – редактируемая сущность;
* `dynamicAttributes` – мэп, где `key` – код атрибута, `value` – значение динамического атрибута.

.Скрипт пересчета значения
image::dynamic_attributes_recalculation.png[align="center"]

Пример скрипта пересчета значения, использующего мэп `dynamicAttributes`:

[source, groovy]
----
include::{sourcesdir}/features/dynamicAttrValidationRecalculation.groovy[]
----

Скрипт выполняется каждый раз после изменения значения одного из атрибутов, от которых зависит данный атрибут.

Если скрипт задан, то поле ввода для атрибута будет нередактируемым.

Пересчет значения атрибута работает только со следующими UI-компонентами: <<gui_Form,Form>>, <<categorized_entity,DynamicAttributesPanel>>.

[[dynamic_attributes_optionsType]]
Поле *Options type* определяет тип загрузчика опций и является обязательным для заполнения, если на вкладке *General* был установлен чекбокс <<dynamic_attributes_lookupField,Lookup field>>. Если чекбокс не был установлен, то поле *Options type* является недоступным для заполнения.

Доступные типы загрузчика опций: Groovy, SQL, JPQL (только для типа данных `Entity`).

* Загрузчик опций Groovy загружает список значений, используя скрипт Groovy. В скрипт передается переменная `entity`, по которой можно получить доступ к атрибутам сущности (включая динамические атрибуты). Пример скрипта для атрибута типа `String`:
+
.Скрипт для загрузчика опций Groovy
image::dynamic_attributes_Groovy_options.png[align="center"]

* Загрузчик опций SQL загружает список значений, используя скрипт SQL. Вы можете получить доступ к идентификатору сущности, используя переменную `${entity}`. Чтобы получить доступ к параметрам сущности, используйте конструкцию `${entity.<field>}`, где `field` – имя параметра сущности. Для доступа к динамическим атрибутам сущности используется префикс `+`, например, `${entity.+<field>}`. Пример скрипта (здесь мы получаем доступ к сущности и динамическому атрибуту `Categorytype`):
+
[source, sql]
----
include::{sourcesdir}/features/dynamicAttrSQL_optionsLoader.sql[]
----

* Загрузчик опций <<jpql,JPQL>> применяется только для динамического атрибута типа `Entity`. JPQL условия задаются в полях *Join Clause* и *Where Clause*. Кроме того вы можете воспользоваться мастером созданий ограничений (*Constraint Wizard*). Мастер позволяет визуально задавать JPQL условия. В параметрах JPQL можно использовать переменные `{entity}` и `{entity.<field>}`.

Для всех типов значения поддерживается локализация имени атрибута на вкладке *Localization*:

.Локализация динамического атрибута
image::runtimePropertyLocalization.png[align="center"]

[[dynamic_attributes_visibility]]
Видимость атрибутов::
+
--
Динамический атрибут также имеет настройки видимости, описывающие, на каких экранах его нужно отображать. По умолчанию атрибут не отображается нигде.

.Настройки видимости динамического атрибута
image::runtimePropertyVisibility.png[align="center"]

Кроме экрана можно также указать компонент, в котором атрибут должен появляться (например, для экранов, где несколько компонентов <<gui_Form,Form>> показывают поля одной и той же сущности).

Если атрибут отмечен как видимый на каком-либо экране, он автоматически отобразится во всех формах и таблицах, отображающих объекты данного типа в данном экране.

Доступ к динамическим атрибутам также может быть ограничен через настройки в <<roles,ролях пользователей>>. Настройки осуществляются так же, как для обычных атрибутов.

Динамические атрибуты можно добавить в экран вручную. Для этого необходимо добавить атрибут `dynamicAttributes="true"` загрузчику сущности и использовать код динамического атрибута с префиксом `+` при привязке UI-компонентов к данным:

[source, xml]
----
include::{sourcesdir}/features/dynamicAttrLoading.xml[]
----
--


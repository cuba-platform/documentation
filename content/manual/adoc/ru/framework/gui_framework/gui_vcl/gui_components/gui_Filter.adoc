:sourcesdir: ../../../../../../source

[[gui_Filter]]
====== Filter

++++
<div class="manual-live-demo-container">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=multiple-filter" class="live-demo-btn" target="_blank">ДЕМОНСТРАЦИЯ</a>
</div>
++++

++++
<div class="manual-live-demo-container">
    <a href="http://files.cuba-platform.com/javadoc/cuba/7.2/com/haulmont/cuba/gui/components/Filter.html" class="api-docs-btn" target="_blank">API DOCS</a>
</div>
++++

В этом разделе:

* <<gui_Filter_use,Использование фильтра>>,

* <<gui_Filter_component,Описание компонента Filter>>,

* <<gui_Filter_permissions,Права пользователей для управления фильтрами>>,

* <<gui_Filter_ext_params,Внешние параметры для управления фильтрами>>,

* <<gui_Filter_sequential_apply,Последовательное наложение фильтров>>,

* <<gui_Filter_params_api,API для работы с параметрами фильтра>>,

* <<gui_Filter_fts,Режим полнотекстового поиска в фильтре>>.

Компонент `Filter` − универсальное средство фильтрации списков сущностей, извлекаемых из базы данных для отображения в табличном виде. Компонент позволяет производить быструю фильтрацию данных по произвольному набору условий, а также создавать фильтры для многократного использования.

`Filter` должен быть связан с контейнером <<gui_collection_container,CollectionContainer>> через <<gui_data_loaders,data loader>> либо с <<datasources,источником данных>> `collectionDatasource`, содержащим <<datasource_query,запрос>> на JPQL. Принцип действия фильтра основан на модификации этого запроса в соответствии с критериями, заданными пользователем. Таким образом, фильтрация осуществляется на уровне БД при выполнении транслированного из JPQL в SQL запроса, и на Middleware и клиентский <<app_tiers,уровень>> загружаются только отобранные данные.

[[gui_Filter_use]]
*Использование фильтра*

Типичный фильтр выглядит следующим образом:

image::gui_filter_descr.png[align="center"]

По умолчанию, компонент находится в режиме быстрой фильтрации. Это означает, что пользователь может добавить набор условий для однократного поиска данных. После закрытия экрана просмотра экземпляров сущности условия будут удалены.

Для того чтобы создать быстрый фильтр, нажмите на ссылку *Add search condition (Добавить условие поиска)*. Отобразится экран выбора условий:

image::gui_filter_conditions.png[align="center"]

Рассмотрим возможные типы условий:

* *Properties (Атрибуты)* – атрибуты данной сущности и связанных с ней сущностей. Отображаются персистентные атрибуты, явно заданные в элементе `property` XML-описателя фильтра, либо соответствующие правилам, указанным в элементе <<gui_Filter_properties,properties>>.

* *Custom conditions (Специальные условия)* – условия, заданные разработчиком в элементах `custom` XML-дескриптора фильтра.

* *Create new (Создать новое)* – позволяет создать новое произвольное условие на JPQL. Данный пункт доступен пользователю, если у него есть специфическое <<permissions,разрешение>> `cuba.gui.filter.customConditions`.

Выбранные условия отображаются в верхней части панель фильтра. Рядом с каждым условием находится кнопка image:gui_filter_remove_condition.png[], позволяющая удалить их из набора.

Быстрый фильтр можно сохранить для повторного использования в дальнейшем. Для этого нажмите на кнопку настроек фильтра и выберите *Save/Save as (Сохранить/Сохранить как)*. Во всплывающем окне задайте имя нового фильтра:

image::gui_filter_name.png[align="center"]

Фильтр будет сохранен в выпадающем меню кнопки *Search (Поиск)*.

Пункт меню *Reset filter (Сбросить фильтр)* позволяет сбросить все текущие условия поиска.

image::gui_filter_reset.png[align="center"]

Кнопка настроек фильтра содержит выпадающий список опций для управления фильтром:

* *Save (Сохранить)* – сохранить изменения в текущем фильтре.

* *Save with values (Сохранить со значениями)* – сохранить изменения в текущем фильтре, использовав значения в редакторах параметров фильтра как значения по умолчанию.

* *Save as (Сохранить как)* – сохранить фильтр под новым именем.

* *Edit (Редактировать)* – открыть редактор фильтра (см. ниже).

* *Make default (Установить по умолчанию)* – установить фильтр по умолчанию для данного экрана. Фильтр будет автоматически выводиться на панель при каждом открытии экрана.

* *Remove (Удалить)* – удалить текущий фильтр. 

* *Pin applied (Закрепить)* – использовать результаты последнего поиска для последовательной фильтрации данных (см. <<gui_Filter_sequential_apply,Последовательное наложение фильтров>>).

* *Save as search folder (Сохранить как папку поиска)* – создать <<search_folder,папку поиска>> на основе текущего фильтра.

* *Save as application folder (Сохранить как папку приложения)* – создать <<application_folder,папку приложения>> на основе текущего фильтра. Эта опция доступна только пользователям со специфическим разрешением `cuba.gui.appFolder.global`.

Опция *Edit* открывает редактор фильтра, который дает возможность расширенной настройки текущего фильтра:

image::gui_filter_editor.png[align="center"]

Название фильтра указывается в поле *Filter name (Имя фильтра)*. Это имя будет отображаться в списке доступных фильтров для текущего экрана.

Фильтр можно сделать _global_ (то есть доступным для всех пользователей) с помощью установки флажка *Available for all users (Общий)* для всех пользователей и _global default_ с помощью флажка *Global default*. Для этих операций пользователю требуется специфическое <<permissions, разрешение>> CUBA > Фильтр > Создание/изменение глобальных фильтров. Если фильтр помечен как _global default_, то он будет автоматически выбран при открытии экрана пользователями. Каждый пользователь может установить свой собственный фильтр по умолчанию с помощью флажка *Default (По умолчанию)*. Эта настройка имеет приоритет над _global default_.

В дереве содержатся условия фильтра. Условия можно добавлять с помощью кнопки *Add (Добавить)* менять местами при помощи кнопок image:gui_filter_cond_down.png[]/image:gui_filter_cond_up.png[] или удалять с помощью кнопки *Remove (Удалить)*.

Группировку условий по И или ИЛИ можно добавить с помощью соответствующих кнопок. Все добавленные на верхний уровень (то есть без явной группировки) условия объединяются по И.

При выборе условия в дереве в правой части редактора открывается список его свойств.

С помощью соответствующих флажков можно сделать выбранное в таблице условие скрытым или обязательным для заполнения. Параметр скрытого условия не отображается пользователю, поэтому он должны быть введен во время редактирования фильтра.

Свойство *Width* позволяет задать ширину поля ввода параметра для текущего условия. По умолчанию, условия на панели фильтров отображаются в три колонки. Ширина поля равняется количеству колонок, которое оно может занять (1, 2 или 3).

Значение параметра текущего условия по умолчанию можно задать в поле *Default value (Значение по умолчанию)*.

Специальный заголовок условия фильтрации можно задать в поле *Caption (Заголовок)*.

Поле *Operation* позволяет выбрать оператор поиска. Список доступных операторов зависит от типа атрибута.

При поиске по атрибуту сущности с типом `DateTime` и без аннотации <<ignoreUserTimeZone,@IgnoreUserTimeZone>> по умолчанию будет учитываться <<timeZone,часовой пояс>> текущего пользователя. Чтобы учитывать часовой пояс для атрибута с типом `Date`, необходимо установить флаг *Use time zone* в редакторе нового условия.

[[gui_Filter_component]]
*Описание компонента Filter*

XML-имя компонента: `filter`.

Пример объявления компонента в XML-дескрипторе экрана:

[source, xml]
----
include::{sourcesdir}/gui_vcl/filter_1.xml[]
---- 

Здесь в элементе `data` определен <<gui_data_containers,data container>>, который выбирает экземпляры сущности `Car` с помощью JPQL запроса. Для компонента `filter` в его атрибуте `loader` указан фильтруемый загрузчик <<gui_data_loaders,data loader>>. Данные отображаются компонентом <<gui_Table,Table>>, связанным с этим же контейнером.

Элемент `filter` может содержать вложенные элементы. Все они описывают условия, доступные пользователю для выбора в диалоге добавления условий:

[[gui_Filter_properties]]
* `properties` - позволяет сделать доступными сразу несколько атрибутов сущности. Данный элемент может иметь следующие атрибуты:
+
--
[[gui_Filter_properties_include]]
** `include` - обязательный атрибут, содержит регулярное выражение, которому должно соответствовать имя атрибута сущности.

[[gui_Filter_properties_exclude]]
** `exclude` - содержит регулярное выражение, при соответствии которому атрибут сущности исключается из ранее включенных с помощью `include`.

[[gui_Filter_properties_excludeProperties]]
** `excludeProperties` – содержит список атрибутов, разделённых запятыми, которые должны быть исключены из фильтрации. В отличие от `exclude`, этот атрибут поддерживает путь по графу сущностей для указания каждого свойства в списке. Например, `customer.name`.

[[gui_Filter_properties_excludeRecursively]]
** `excludeRecursively` - указывает, должны ли атрибуты, перечисленные в `excludeProperties`, быть рекурсивно исключены из полного графа сущностей. Если установлено `true`, указанный атрибут и все одноименные атрибуты вглубь по графу сущностей не будут использоваться в фильтре.
+
Пример:
+
[source, xml]
----
include::{sourcesdir}/gui_vcl/filter_2.xml[]
----
+
Чтобы программно исключить атрибуты из фильтра, используйте метод `setPropertiesFilterPredicate()` компонента `Filter`:
+
[source, java]
----
include::{sourcesdir}/gui_vcl/filter_7.java[]
----

При использовании элемента `properties` автоматически игнорируются следующие атрибуты сущности:

** Недоступные в связи с <<permissions,разрешениями>> подсистемы безопасности.

** Коллекции (`@OneToMany`, `@ManyToMany`).

** Неперсистентные атрибуты.

** Атрибуты, не имеющие <<entity_localization,локализованного названия>>.

** Атрибуты, аннотированные `@SystemLevel`.

** Атрибуты типа `byte[]`.

** Атрибут `version`.
--

[[gui_Filter_property]]
* `property` - явно включает атрибут сущности по имени. Данный элемент может иметь следующие атрибуты:
+
--
[[gui_Filter_property_name]]
** `name` - обязательный атрибут, содержит имя включаемого атрибута сущности. Может быть путем (через ".") по графу сущностей. Например: 
+
[source, xml]
----
include::{sourcesdir}/gui_vcl/filter_3.xml[]
---- 

[[gui_Filter_property_caption]]
** `caption` - локализованное название атрибута сущности для отображения условия фильтра. Как правило, представляет собой строку с префиксом `msg://` по правилам <<messageTools.loadString,MessageTools.loadString()>>.
+
Если в атрибуте `name` указан путь (через ".") по графу сущностей, то атрибут `caption` является обязательным.

[[gui_Filter_property_paramWhere]]
** `paramWhere` − задает выражение на JPQL для отбора списка значений параметра условия, если параметр является связанной сущностью. Вместо алиаса сущности параметра в выражении нужно использовать метку (placeholder) `{E}`.
+
Например, предположим, что сущность `Car` имеет ссылку на сущность `Model`. Тогда список возможных значений параметра может быть ограничен только моделями `*Audi*`: 
+
[source, xml]
----
include::{sourcesdir}/gui_vcl/filter_4.xml[]
---- 
+
В выражении JPQL можно использовать параметры экрана, атрибуты сессии, а также компоненты экрана, в том числе отображающие другие параметры. Правила задания параметров запроса описаны в https://doc.cuba-platform.com/manual-latest/gui_data_comp_dep.html[Dependencies Between Data Components] и <<datasource_query,>>.
+
Пример использования параметра сессии и параметра экрана: 
+
[source, jpql]
----
{E}.createdBy = :session$userLogin and {E}.name like :param$groupName
---- 
+
Используя `paramWhere` можно вводить зависимости между параметрами. Например, предположим, что `Manufacturer` является отдельной сущностью. То есть `Car` ссылается на `Model`, которая в свою очередь ссылается на `Manufacturer`. Тогда для фильтра по `Car` можно создать два условия: первое для выбора `Manufacturer` и второе для выбора `Model`. Чтобы ограничить список моделей выбранным перед этим производителем, добавьте в выражение `paramWhere` параметр: 
+
[source, jpql]
----
{E}.manufacturer.id = :component$filter.model_manufacturer90062
---- 
+
Здесь параметр ссылается на компонент, отображающий параметр Manufacturer. Имя компонента, отображающего параметр условия, можно узнать, вызвав контекстное меню на строке таблицы условий в редакторе фильтра:
+
[[gui_Filter_parameter_component_name]]
image::gui_filter_component_name.png[align="center"]

[[gui_Filter_property_paramView]]
** `paramView` − задает <<views,представление>>, с которым будет загружаться список значений параметра условия, если параметр является связанной сущностью. Например, `++_local++`. Если не указано, используется `++_minimal++`.
--

[[gui_Filter_custom]]
* `custom` - элемент, определяющий произвольное условие. Содержимым элемента должно быть выражение на JPQL (возможно использование <<jpql_macro,JPQL Macros>>), которое будет добавлено в условие `where` запроса контейнера данных. Вместо алиаса отбираемой сущности в выражении нужно использовать метку (placeholder) `{E}`. Параметр условия может быть только один, и если он есть, обозначается символом `?`.
+
--
Значение условия может содержать спецсимволы, например "%" или "_" для оператора "like". Если вам нужно экранировать эти символы, добавьте в условие `escape '<char>'`, например:

[source, sql]
----
{E}.name like ? escape '\'
----

Тогда если в значении параметра условия будет передано `foo\%`, поиск будет интерпретировать "%" как символ в имени а не как спецсимвол.

Пример фильтра с произвольными условиями:

[source, xml]
----
include::{sourcesdir}/gui_vcl/filter_5.xml[]
---- 

Созданные `custom` условия отображаются в секции *Специальные условия* диалога добавления условий:

image::gui_filter_custom.png[align="center"]

Атрибуты элемента `custom`:

[[gui_Filter_custom_name]]
** `name` − обязательный атрибут - имя условия.

[[gui_Filter_custom_caption]]
** `caption` − обязательный атрибут - локализованное название условия. Как правило, представляет собой строку с префиксом `msg://` по правилам <<messageTools.loadString,MessageTools.loadString>>().

[[gui_Filter_custom_paramClass]]
** `paramClass` − Java-класс параметра условия. Если параметр отсутствует, то данный атрибут не обязателен.

[[gui_Filter_custom_inExpr]]
** `inExpr` − должен быть установлен в `true`, если выражение JPQL содержит условие `in (?)`. При этом пользователь будет иметь возможность ввести несколько значений параметра данного условия.

[[gui_Filter_custom_join]]
** `join` − необязательный атрибут для задания строки, которая будет добавлена в секцию `from` запроса контейнера данных. Это может потребоваться для создания условия по атрибуту связанной коллекции. Значение данного атрибута должно включать в себя предложения `join` или `left join`.
+
Например, предположим что сущность `Car` имеет атрибут `repairs`, который представляет собой коллекцию экземпляров связанной сущности `Repair`. Тогда для фильтрации `Car` по атрибуту `description` сущности `Repair` можно написать следующее условие: 
+
[source, xml]
----
include::{sourcesdir}/gui_vcl/filter_6.xml[]
---- 
+
При использовании такого условия исходный запрос контейнера:
+
[source, jpql]
----
select c from sample_Car c order by c.createTs
----
+
будет трансформирован в следующий:
+
[source, jpql]
----
select c from sample_Car c join c.repairs cr
where (cr.description like ?)
order by c.createTs
----

** `paramWhere` − задает выражение на JPQL для отбора списка значений параметра условия, если параметр является связанной сущностью. См. описание одноименного <<gui_Filter_property_paramWhere,атрибута>> элемента `property`.

** `paramView` − задает <<views,представление>>, с которым будет загружаться список значений параметра условия, если параметр является связанной сущностью. См. описание одноименного <<gui_Filter_property_paramView,атрибута>> элемента `property`.
--

Атрибуты `filter`:

[[gui_Filter_editable]]
* `editable` - если значение этого атрибута равно `false`, то кнопка *Фильтр* скрывается.

[[gui_filter_immediately]]
* `applyImmediately` – указывает, когда применять фильтр. Если значение атрибута `false`, то фильтр будет применен только после нажатия кнопки **Search**. Если значение атрибута `true`, фильтр применяется сразу после изменения условий фильтрации. Общие случаи, когда фильтр применяется немедленно:
+
--
** После изменения значения поля ввода параметра условия;
** После изменения условия поиска;
** После удаления условия из фильтра;
** После изменения значения в поле **Show rows**;
** При нажатии на кнопку **OK** в диалоговом окне редактора фильтра;
** После очистки всех значений.

В режиме немедленного исполнения вместо кнопки **Search** будет использоваться кнопка **Refresh**.

Атрибут `applyImmediately` имеет приоритет над свойством приложения <<cuba.gui.genericFilterApplyImmediately,cuba.gui.genericFilterApplyImmediately>>.
--

[[gui_Filter_manualApplyRequired]]
* `manualApplyRequired` − определяет, в какой момент будет применяться фильтр. Если значение атрибута равно `false`, то фильтр (пустой или по умолчанию) будет применяться сразу при открытии экрана. Это означает, что контейнер данных будет обновлен и связанные компоненты (например, `Table`) отобразят данные. Если значение атрибута равно `true`, то фильтр будет применяться только после нажатия на кнопку *Search*.
+
Данный атрибут имеет приоритет над свойством приложения <<cuba.gui.genericFilterManualApplyRequired,cuba.gui.genericFilterManualApplyRequired>>.

[[gui_Filter_useMaxResults]]
* `useMaxResults` − ограничивает размер страницы загружаемых в контейнер данных экземпляров сущности. По умолчанию `true`.
+
Если значение этого атрибута равно `false`, то фильтр не будет отображать поле *Show rows*. Количество записей в контейнере (и соответственно, показываемых таблицей) будет ограничено только параметром `MaxFetchUI` механизма <<entity_statistics,статистики сущностей>>, по умолчанию - 10000.
+
Если данный атрибут не указан, или равен `true`, то поле *Show rows* отображается, если у пользователя также есть специфическое разрешение <<permissions,cuba.gui.filter.maxResults>>. Если разрешение `cuba.gui.filter.maxResults` отсутствует, то фильтр будет принудительно отбирать только первые N строк без возможности пользователя отключить это или указать другое N. Число N определяется параметрами `FetchUI`, `DefaultFetchUI`, получаемыми из механизма <<entity_statistics,статистики сущностей>>.
+
На рисунке далее показан вид фильтра со значением атрибута `useMaxResults="true"`, запретом специфического разрешения `cuba.gui.filter.maxResults` и параметром `DefaultFetchUI=2`
+
image::gui_filter_useMaxRezult.png[align="center"]

[[gui_Filter_textMaxResults]]
* `textMaxResults` - позволяет использовать текстовое поле вместо выпадающего списка в качестве поля *Show rows*. По умолчанию `false`.

[[gui_Filter_folderActionsEnabled]]
* `folderActionsEnabled` − при указании значения `false` позволяет скрыть следующие действия с фильтром: *Сохранить как папку поиска*, *Сохранить как папку приложения*. По умолчанию значение атрибута равно `true`, действия *Сохранить как папку поиска*, *Сохранить как папку приложения* доступны.

[[gui_Filter_applyTo]]
* `applyTo` − необязательный атрибут, содержит идентификатор компонента, с которым связан фильтр. Используется в случае, когда необходимо иметь доступ к <<gui_Table_presentations,представлениям>> связанного компонента-таблицы. Например, сохраняя фильтр как <<search_folder,папку поиска>> или как <<application_folder,папку приложения>>, можно указать, какое представление будет применяться при просмотре этой папки.
+
image::gui_filter_apply_to.png[align="center"]

[[gui_Filter_caption]]
* `caption` - позволяет задать заголовок панели фильтров.

[[gui_Filter_columnsCount]]
* `columnsCount` - задает количество колонок с условиями для конкретного фильтра. Значение по умолчанию - 3.

[[gui_Filter_defaultMode]]
* `defaultMode` - задает режим фильтра при открытии экрана. Возможные значения: `generic` и `fts`. При указании значения `fts` фильтр будет открыт в режиме полнотекстового поиска (если сущность индексируется). Значение по умолчанию - `generic`.

[[gui_Filter_modeSwitchVisible]]
* `modeSwitchVisible` - определяет видимость чек-бокса для перевода фильтра в режим полнотекстового поиска. Если полнотекстовый поиск невозможен, то чек-бокс будет невидим независимо от указанного значения. Возможные значения атрибута: `true` и `false`.

*Методы интерфейса Filter:*

* `setBorderVisible()` - определяет видимость границы фильтра. Значение по умолчанию - `true`.

*Слушатели компонента Filter:*
[[gui_Filter_ExpandedStateChangeListener]]
* `ExpandedStateChangeListener` - позволяет отслеживать изменения состояния компонента (свёрнутое/развёрнутое).

[[gui_Filter_FilterEntityChangeListener]]
* `FilterEntityChangeListener` - срабатывает при первом выборе фильтра и дальнейшем выборе сохранённых фильтров.

Внешний вид компонента `Filter` можно настроить с помощью переменных SCSS с префиксом `$cuba-filter-*`. Эти переменные можно изменить в визуальном редакторе после <<web_theme_extension,расширения темы>> или создания <<web_theme_creation,новой темы>>.

'''

Атрибуты filter::
<<gui_filter_immediately,applyImmediately>> -
<<gui_Filter_applyTo,applyTo>> -
<<gui_Filter_caption,caption>> -
<<gui_attr_captionAsHtml,captionAsHtml>> -
<<gui_Filter_columnsCount,columnsCount>> -
<<gui_attr_css,css>> -
<<gui_attr_dataLoader,dataLoader>> -
<<gui_attr_datasource,datasource>> -
<<gui_Filter_defaultMode,defaultMode>> -
<<gui_attr_description,description>> -
<<gui_attr_descriptionAsHtml,descriptionAsHtml>> -
<<gui_Filter_editable,editable>> -
<<gui_attr_enable,enable>> -
<<gui_attr_expandRatio,box.expandRatio>> -
<<gui_Filter_folderActionsEnabled,folderActionsEnabled>> -
<<gui_attr_id,id>> -
<<gui_Filter_manualApplyRequired,manualApplyRequired>> -
<<gui_attr_margin,margin>> -
<<gui_Filter_modeSwitchVisible,modeSwitchVisible>> -
<<gui_attr_settingsEnabled,settingsEnabled>> -
<<gui_attr_stylename,stylename>> -
<<gui_Filter_textMaxResults,textMaxResults>> -
<<gui_Filter_useMaxResults,useMaxResults>> -
<<gui_attr_visible,visible>> -
<<gui_attr_width,width>>

Элементы filter::
<<gui_Filter_custom,custom>> -
<<gui_Filter_properties,properties>> -
<<gui_Filter_property,property>>

Атрибуты properties::
<<gui_Filter_properties_exclude,exclude>> -
<<gui_Filter_properties_excludeProperties,excludeProperties>> -
<<gui_Filter_properties_include,include>>

Атрибуты property::
<<gui_Filter_property_caption,caption>> -
<<gui_Filter_property_name,name>> -
<<gui_Filter_property_paramView,paramView>> -
<<gui_Filter_property_paramWhere,paramWhere>>

Атрибуты custom::
<<gui_Filter_custom_caption,caption>> -
<<gui_Filter_custom_name,name>> -
<<gui_Filter_custom_inExpr,inExpr>> -
<<gui_Filter_custom_join,join>> -
<<gui_Filter_custom_paramClass,paramClass>> -
<<gui_Filter_property_paramView,paramView>> -
<<gui_Filter_property_paramWhere,paramWhere>>

API::
<<gui_api_expanded,addExpandedStateChangeListener>> -
<<gui_Filter_FilterEntityChangeListener,addFilterEntityChangeListener>> -
<<gui_api_settings,applySettings>> -
<<gui_api_margin,getMargin>> -
<<gui_api_settings,saveSettings>> -
<<gui_api_margin,setMargin>>

'''

[[gui_Filter_permissions]]
*Права пользователей*

* Для создания/изменения/удаления глобальных (доступных всем пользователям) фильтров пользователь должен иметь разрешение `cuba.gui.filter.global`.

* Для создания/изменения `custom` условий пользователь должен иметь разрешение `cuba.gui.filter.customConditions`.

* Чтобы иметь возможность изменять максимальное количество строк на странице таблицы с помощью флажка и поля *Show rows* пользователь должен иметь разрешение `cuba.gui.filter.maxResults`. См. также атрибут фильтра <<gui_Filter_useMaxResults,useMaxResults>>.

Информация о том, как настраивать специфические разрешения, приведена в руководстве Подсистема безопасности.

[[gui_Filter_ext_params]]
*Внешние параметры для управления фильтрами*

[[gui_Filter_app_properties]]
* *Общесистемные параметры*
+
--
Следующие свойства приложения влияют на поведение фильтров:

* <<cuba.gui.genericFilterApplyImmediately,cuba.gui.genericFilterApplyImmediately>> позволяет управлять режимом фильтрации по умолчанию. См. также атрибут фильтра <<gui_filter_immediately,applyImmediately>>.

* <<cuba.gui.genericFilterManualApplyRequired,cuba.gui.genericFilterManualApplyRequired>> − позволяет отключить автоматическое применение фильтра (то есть загрузку данных) сразу при открытии экрана. См. также атрибут фильтра <<gui_Filter_manualApplyRequired,manualApplyRequired>>.

* <<cuba.gui.genericFilterChecking,cuba.gui.genericFilterChecking>> − позволяет включить проверку заполненности хотя-бы одного условия перед применением фильтра.

* <<cuba.gui.genericFilterControlsLayout,cuba.gui.genericFilterControlsLayout>> − определяет расположение элементов внутри фильтра.

* <<cuba.allowQueryFromSelected,cuba.allowQueryFromSelected>> позволяет отключить механизм <<gui_Filter_sequential_apply,последовательного наложения фильтров>>.

* <<cuba.gui.genericFilterColumnsCount,cuba.gui.genericFilterColumnsCount>> - задает количество колонок по умолчанию для размещения условий фильтра. См также атрибут фильтра <<gui_Filter_columnsCount,columnsCount>>.

* <<cuba.gui.genericFilterConditionsLocation,cuba.gui.genericFilterConditionsLocation>> - задает расположение панели условий.

* <<cuba.gui.genericFilterPopupListSize,cuba.gui.genericFilterPopupListSize>> - задает количество позиций в выпадающем списке кнопки *Search*.

* <<cuba.gui.genericFilterPropertiesHierarchyDepth,cuba.gui.genericFilterPropertiesHierarchyDepth>> - oпределят глубину вложенности атрибутов сущности в диалоговом окне "Добавить условие".

* <<cuba.gui.genericFilterTrimParamValues,cuba.gui.genericFilterTrimParamValues>> - определяет, нужно ли обрезать пробелы в начале и конце строки текстового поиска.
--

[[gui_Filter_screen_parameters]]
* *Параметры вызова экрана*
+
--
При вызове экрана можно указать, какой фильтр и с какими параметрами должен быть применен сразу после открытия экрана. Для этого фильтр должен быть заранее создан, сохранен в базе данных, и соответствующая запись в таблице `SEC_FILTER` должна иметь заполненное поле `CODE`. Параметры вызова экрана задаются в конфигурационном файле `web-menu.xml`.

Чтобы сохранить фильтр в базе данных, необходимо добавить скрипт вставки фильтра в скрипт `30.create-db.sql` сущности. Для генерации скрипта найдите фильтр в справочнике *Entity Inspector* меню *Administration*, в контекстном меню выберите *System Information*, нажмите на кнопку *Script for insert* и скопируйте текст скрипта.

Теперь можно добавить скрипт к экрану. Для указания кода фильтра в экран следует передать параметр с именем, равным идентификатору компонента фильтра в данном экране. Значением параметра должен быть код фильтра, который нужно установить и применить.

Для установки значений параметров фильтра в экран нужно передать параметры с именами, равными именам параметров, и значения в виде строк.

Пример описателя пункта главного меню, устанавливающего в открываемом экране `sample_Car.browse` в компоненте `carsFilter` фильтр с кодом `FilterByVIN`, с подстановкой в параметр условия `component$carsFilter.vin79216` значения `TMA`:

[source, xml]
----
include::{sourcesdir}/gui_vcl/filter_ext_param_1.xml[]
----

Следует отметить, что фильтр с установленным полем `CODE` обладает особыми свойствами:

* Его не могут редактировать пользователи.

* Название такого фильтра можно отображать на нескольких языках. Для этого в <<main_message_pack,главном пакете сообщений>> приложения должна быть строка с ключом, равным коду фильтра.
--

[[gui_Filter_sequential_apply]]
*Последовательное наложение фильтров*

При включенном свойстве приложения <<cuba.allowQueryFromSelected,cuba.allowQueryFromSelected>> в пользовательском интерфейсе компонента можно закреплять последний примененный фильтр и текущие результаты фильтрации. После этого можно выбрать другой фильтр или параметры и применить их на уже выбранных записях.

Данный подход позволяет решить две проблемы:

* Декомпозировать сложные фильтры.

* Применять фильтры на записи, отобранные с помощью папок <<application_folder,приложения>> или <<search_folder,поиска>>.

Чтобы применить этот механизм в пользовательском интерфейсе, выберите и примените один из фильтров. Затем нажмите на кнопку настроек фильтра и выберите *Pin applied (Закрепить)*. Фильтр закрепится в верхней части панели фильтров. Далее можно применить к выбранным записям другой фильтр. Так последовательно можно накладывать друг на друга любое количество фильтров. Также фильтры можно удалять последовательно с помощью кнопки image:gui_filter_remove.png[].

image::gui_filter_sequential.png[align="center"]

Механизм последовательного наложения фильтров основан на возможности <<dataManager,DataManager>> выполнять <<query_from_selected,последовательные запросы>>.

[[gui_Filter_params_api]]
*API для работы с параметрами фильтра*

Интерфейс `Filter` предоставляет методы для установки и чтения значений параметра фильтра из кода контроллера экрана:

* `setParamValue(String paramName, Object value)`
* `getParamValue(String paramName)`

`paramName` - имя параметра фильтра. Имя параметра фильтра является составной частью имени компонента, отображающего значение параметра фильтра. Как получить имя компонента рассматривалось <<gui_Filter_parameter_component_name, выше>>. Имя параметра - это часть имени компонента, находящаяся после последней точки. Например, если имя компонента `component$filter.model_manufacturer90062`, то имя параметра фильтра `model_manufacturer90062`.

Обратите внимание, что в обработчике <<screen_InitEvent,InitEvent>> контроллера экрана данные методы использовать нельзя, т.к. в этот момент фильтр еще не проинициализирован. Вы можете работать с параметрами фильтра в обработчике <<screen_BeforeShowEvent,BeforeShowEvent>>.

[[gui_Filter_fts]]
*Режим полнотекстового поиска в фильтре*

Если контейнер данных фильтра содержит сущности, индексируемые системой полнотекстового поиска (см. link:{fts_man_url}[Платформа CUBA. Полнотекстовый поиск]), то в фильтре становится доступным режим полнотекстового поиска. Чтобы переключиться в него, используйте флажок *Full-Text Search* ("Полнотекстовый поиск").

image::gui_filter_fts.png[align="center"]

В этом режиме фильтр имеет поля для ввода критериев поиска, и поиск производится по индексируемым подсистемой FTS полям сущности.

Если таблица указана в атрибуте <<gui_Filter_applyTo,applyTo>>, то при наведении указателя мыши на строку таблицы во всплывающем окне будет написано, в каких полях сущности было найдено условие поиска.

Для скрытия переключателя режима фильтра установите значение `false` атрибуту фильтра <<gui_Filter_modeSwitchVisible,modeSwitchVisible>>.

Если необходимо, чтобы фильтр по умолчанию открывался в режиме полнотекстового поиска, установите значение `fts` атрибуту <<gui_Filter_defaultMode,defaultMode>>.

Полнотекстовый поиск может использоваться совместно с любым количеством условий универсального фильтра:

image::book_publication_fts_filter.png[align="center"]

Выбрать условие *FTS condition* можно в окне выбора условий фильтра.


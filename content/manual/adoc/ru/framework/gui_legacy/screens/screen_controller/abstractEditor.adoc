:sourcesdir: ../../../../../../source

[[abstractEditor]]
====== AbstractEditor

[WARNING]
====
Это устаревший API. Новый API, доступный начиная с v.7.0, описан в разделе <<screen_controllers>>.
====

`AbstractEditor` − базовый класс контроллеров <<screen_edit,экранов редактирования>>, является наследником <<abstractWindow,AbstractWindow>>.

При создании конкретного класса контроллера рекомендуется параметризовать `AbstractEditor` типом редактируемой сущности. При этом методы `getItem()` и `initNewItem()` будут работать с конкретным типом сущности и прикладному коду не потребуется дополнительных приведений типов. Например:

[source, java]
----
include::{sourcesdir}/gui/abstracteditor_1.java[]
----

`AbstractEditor` определяет следующие собственные методы:

[[abstractEditor_getItem]]
* `getItem()` - возвращает экземпляр редактируемой сущности, установленный в главном источнике данных экрана (т.е. указанном в атрибуте `datasource` корневого элемента XML-дескриптора).
+
Если редактируется не новый экземпляр, то в момент открытия экрана он перезагружается из базы данных с необходимым <<views,представлением>>, указанным для главного источника данных. 
+
Изменения, вносимые в экземпляр, возвращаемый `getItem()`, отражаются на состоянии источника данных, и будут отправлены на *Middleware* при коммите экрана.
+
[WARNING]
====
Следует иметь в виду, что `getItem()` возвращает значение только после инициализации экрана методом `setItem()`. До этого момента, например, в методах `init()` и `initNewItem()`, данный метод возвращает `null`.

Однако в методе `init()` экземпляр сущности, переданный в `openEditor()`, можно получить из параметров следующим образом:

[source, java]
----
include::{sourcesdir}/gui/abstracteditor_2.java[]
----

В метод `initNewItem()` экземпляр передается явно и нужного типа.

В обоих случаях полученный экземпляр сущности, если он не новый, будет впоследствии перезагружен, и вносить в него изменения или сохранять в поле для последующего использования не имеет смысла.
====

[[abstractEditor_setItem]]
* `setItem()` - вызывается фреймворком при открытии экрана методом `openEditor()` для установки редактируемого экземпляра сущности в главном источнике данных. В момент вызова созданы все компоненты и источники данных экрана, и отработал метод `init()` контроллера.
+
Для инициализации экрана редактирования вместо переопределения `setItem()` рекомендуется имплементировать специальные шаблонные методы `initNewItem()` и `postInit()`.

[[initNewItem]]
* `initNewItem()` - шаблонный метод, вызываемый фреймворком перед установкой редактируемого экземпляра сущности в главном источнике данных.
+
[TIP]
====
Метод `initNewItem()` вызывается только для нового, только что созданного экземпляра сущности. Если редактируется <<entity_states,detached>> экземпляр, метод не вызывается.
====
+
Данный метод можно имплементировать в контроллере при необходимости инициализации нового экземпляра сущности перед его установкой в источник данных, например:
+
[source, java]
----
include::{sourcesdir}/gui/abstracteditor_3.java[]
----
+
Более сложный пример использования `initNewItem()` приведен в разделе <<init_values_in_initNewItem,рецептов разработки>>.

[[abstractEditor_postInit]]
* `postInit()` - шаблонный метод, вызываемый фреймворком сразу после установки редактируемого экземпляра сущности в главном источнике данных. Во время выполнения данного метода можно вызывать `getItem()`, который будет возвращать новый или перезагруженный при инициализации экрана экземпляр сущности.
+
Данный метод можно имплементировать в контроллере для окончательной инициализации экрана, например:
+
[source, java]
----
include::{sourcesdir}/gui/abstracteditor_4.java[]
----

[[abstractEditor_commit]]
* `commit()` - валидировать экран и отправить изменения через <<dataSupplier,DataSupplier>> на *Middleware*.
+
Если используется вариант метода с параметром `validate = false`, то валидация перед коммитом не производится.
+
Данный метод не рекомендуется переопределять, лучше использовать специальные шаблонные методы `postValidate()`, `preCommit()` и `postCommit()`.

[[abstractEditor_commitAndClose]]
* `commitAndClose()` - валидировать экран, отправить изменения на *Middleware* и закрыть экран. В метод `preClose()` и зарегистрированным слушателям `CloseListener` будет передано значение константы `++Window.COMMIT_ACTION_ID++`.
+
Данный метод не рекомендуется переопределять, лучше использовать специальные шаблонные методы `postValidate()`, `preCommit()` и `postCommit()`.

[[abstractEditor_preCommit]]
* `preCommit()` - шаблонный метод, вызываемый фреймворком в процессе коммита изменений, после того как валидация завершена успешно и перед отправкой данных на *Middleware*.
+
Данный метод можно имплементировать в контроллере. Если метод возвращает `false`, процесс коммита (и закрытия экрана, если был вызван `commitAndClose()`), прерывается. Например:
+
[source, java]
----
include::{sourcesdir}/gui/abstracteditor_5.java[]
----

[[abstractEditor_postCommit]]
* `postCommit()` - шаблонный метод, вызываемый фреймворком на финальной стадии коммита изменений. Параметры метода:

** `committed` - установлен в `true`, если в экране действительно были изменения, и они отправлены на *Middleware*;

** `close` - установлен в `true`, если экран после коммита будет закрыт.
+
Реализация метода по умолчанию, если экран не закрывается, отображает сообщение об успешном коммите изменений и вызывает метод `postInit()`.
+
Данный метод можно переопределить в контроллере для выполнения некоторых действий после успешного коммита, например:
+
[source, java]
----
include::{sourcesdir}/gui/abstracteditor_6.java[]
----

Далее приведены диаграммы последовательностей инициализации и различных вариантов коммита экрана редактирования.

.Инициализация экрана редактирования
image::EditorInit.svg[align="center"]

.Коммит и закрытие экрана с фреймом editWindowActions
image::EditorCommit.svg[align="center"]

.Коммит экрана с фреймом extendedEditWindowActions
image::ExtendedEditorCommit.svg[align="center"]

.Коммит и закрытие экрана с фреймом extendedEditWindowActions
image::ExtendedEditorCommitAndClose.svg[align="center"]

'''

API::

<<abstractEditor_commit,commit()>> -
<<abstractEditor_commitAndClose,commitAndClose()>> -
<<abstractEditor_getItem,getItem()>> -
<<initNewItem,initNewItem()>> -
<<abstractEditor_postCommit,postCommit()>> -
<<abstractEditor_postInit,postInit()>> -
<<abstractEditor_preCommit,preCommit()>> -
<<abstractEditor_setItem,setItem()>>

'''

